

=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\androidTest\java\com\example\gymtrack\ExampleInstrumentedTest.kt
=========================================

package com.example.gymtrack

import androidx.test.platform.app.InstrumentationRegistry
import androidx.test.ext.junit.runners.AndroidJUnit4

import org.junit.Test
import org.junit.runner.RunWith

import org.junit.Assert.*

/**
 * Instrumented test, which will execute on an Android device.
 *
 * See [testing documentation](http://d.android.com/tools/testing).
 */
@RunWith(AndroidJUnit4::class)
class ExampleInstrumentedTest {
    @Test
    fun useAppContext() {
        // Context of the app under test.
        val appContext = InstrumentationRegistry.getInstrumentation().targetContext
        assertEquals("com.example.gymtrack", appContext.packageName)
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\data\repository\NoteRepository.kt
=========================================

package com.example.gymtrack.core.data.repository

import com.example.gymtrack.core.data.NoteDao
import com.example.gymtrack.core.data.NoteEntity
import com.example.gymtrack.core.data.NoteLine
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.map

// REMOVED: @Inject annotation
class NoteRepository(private val dao: NoteDao) {

    fun getAllNotes(): Flow<List<NoteLine>> = dao.getAll().map { entities ->
        entities.map { it.toDomainModel() }
    }

    suspend fun saveNote(note: NoteLine) {
        dao.insert(note.toEntity())
    }

    suspend fun deleteNotes(notes: Set<NoteLine>) {
        notes.forEach { dao.delete(it.toEntity()) }
    }

    suspend fun getNoteById(id: Long): NoteLine? {
        return dao.getById(id)?.toDomainModel()
    }
}

// Mappers
fun NoteEntity.toDomainModel() = NoteLine(title, text, timestamp, categoryName, categoryColor, learnings ?: "")
fun NoteLine.toEntity() = NoteEntity(timestamp, title, text, categoryName, categoryColor, learnings)


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\data\Database.kt
=========================================

package com.example.gymtrack.core.data

import android.content.Context
import androidx.room.*
import kotlinx.coroutines.flow.Flow

@Entity(tableName = "notes")
data class NoteEntity(
    @PrimaryKey val timestamp: Long,
    val title: String,
    val text: String,
    val categoryName: String?,
    val categoryColor: Long?,
    val learnings: String?,
)

data class ExerciseWithCount(
    val exerciseId: Long,
    val name: String,
    val setTotalCount: Int
)

@Entity(tableName = "exercises")
data class ExerciseEntity(
    @PrimaryKey(autoGenerate = true) val exerciseId: Long = 0,
    val name: String,
    val parentId: Long? = null,
    val muscleGroup: String?,
    val aliases: String
)

@Entity(
    tableName = "sets",
    foreignKeys = [
        ForeignKey(
            entity = ExerciseEntity::class,
            parentColumns = ["exerciseId"],
            childColumns = ["exerciseId"],
            onDelete = ForeignKey.CASCADE
        )
    ],
    indices = [Index(value = ["exerciseId"]), Index(value = ["workoutId"])]
)
data class SetEntity(
    @PrimaryKey(autoGenerate = true) val setId: Long = 0,
    val workoutId: Long, // This acts as the timestamp
    val exerciseId: Long,
    val weight: Float,
    val reps: Int,
    val isUnilateral: Boolean,
    val modifier: String? = null,
    val brand: String? = null,
    val relativeTime: String? = null,
    val absoluteTime: String? = null
)

data class GraphPoint(val originTimestamp: Long, val avgVal: Float)

// --- DAOS ---

@Dao
interface NoteDao {
    @Query("SELECT * FROM notes ORDER BY timestamp ASC")
    fun getAll(): Flow<List<NoteEntity>>

    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insert(note: NoteEntity)

    @Delete
    suspend fun delete(note: NoteEntity)

    @Query("SELECT * FROM notes WHERE timestamp = :id LIMIT 1")
    suspend fun getById(id: Long): NoteEntity?

    @Query("SELECT COUNT(*) FROM notes")
    suspend fun getCount(): Int
}

@Dao
interface ExerciseDao {
    @Query("SELECT * FROM exercises")
    fun getAllExercises(): Flow<List<ExerciseEntity>>

    @Query("SELECT * FROM exercises WHERE name = :name LIMIT 1")
    suspend fun getByName(name: String): ExerciseEntity?

    @Insert(onConflict = OnConflictStrategy.IGNORE)
    suspend fun insert(exercise: ExerciseEntity): Long

    @Query("SELECT * FROM exercises WHERE aliases LIKE '%' || :query || '%'")
    suspend fun findByAlias(query: String): List<ExerciseEntity>

    // [OLD - Keeps ALL time count]
    @Query("""
        SELECT 
            T1.exerciseId, 
            T1.name, 
            COUNT(T2.exerciseId) AS setTotalCount
        FROM exercises AS T1
        LEFT JOIN sets AS T2 ON T1.exerciseId = T2.exerciseId
        GROUP BY T1.exerciseId, T1.name
        ORDER BY setTotalCount DESC, T1.name ASC
    """)
    fun getExercisesSortedByCount(): Flow<List<ExerciseWithCount>>

    // [FIX - NEW QUERY] Filters by time range
    @Query("""
        SELECT 
            T1.exerciseId, 
            T1.name, 
            COUNT(T2.exerciseId) AS setTotalCount
        FROM exercises AS T1
        JOIN sets AS T2 ON T1.exerciseId = T2.exerciseId
        WHERE T2.workoutId >= :minTimestamp
        GROUP BY T1.exerciseId, T1.name
        ORDER BY setTotalCount DESC, T1.name ASC
    """)
    fun getExercisesWithCountAfter(minTimestamp: Long): Flow<List<ExerciseWithCount>>
}

@Dao
interface SetDao {
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insertSets(sets: List<SetEntity>)

    @Query("DELETE FROM sets WHERE workoutId = :workoutId")
    suspend fun deleteSetsForWorkout(workoutId: Long)

    @Query("DELETE FROM sets WHERE workoutId NOT IN (SELECT timestamp FROM notes)")
    suspend fun deleteOrphanedSets()

    @Query("SELECT COUNT(*) FROM sets")
    suspend fun getCount(): Int

    @Query("""
        SELECT 
            workoutId AS originTimestamp, 
            CAST(SUM(weight * reps) AS REAL) / SUM(reps) AS avgVal 
        FROM sets 
        WHERE exerciseId = :exerciseId 
        GROUP BY workoutId 
        ORDER BY workoutId ASC
    """)
    fun getAverageWeightHistory(exerciseId: Long): Flow<List<GraphPoint>>

    @Transaction
    suspend fun replaceSetsForWorkout(workoutId: Long, sets: List<SetEntity>) {
        deleteSetsForWorkout(workoutId)
        if (sets.isNotEmpty()) {
            insertSets(sets)
        }
    }
}

@Database(entities = [NoteEntity::class, ExerciseEntity::class, SetEntity::class], version = 8)
abstract class NoteDatabase : RoomDatabase() {
    abstract fun noteDao(): NoteDao
    abstract fun exerciseDao(): ExerciseDao
    abstract fun setDao(): SetDao

    companion object {
        @Volatile
        private var INSTANCE: NoteDatabase? = null
        fun getDatabase(context: Context): NoteDatabase {
            return INSTANCE ?: synchronized(this) {
                Room.databaseBuilder(context.applicationContext, NoteDatabase::class.java, "note_database")
                    .fallbackToDestructiveMigration()
                    .build().also { INSTANCE = it }
            }
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\data\ExerciseFlag.kt
=========================================

package com.example.gymtrack.core.data

enum class ExerciseFlag {
    BILATERAL,
    UNILATERAL,
    SUPERSET;

    fun next(): ExerciseFlag = when (this) {
        BILATERAL -> UNILATERAL
        UNILATERAL -> SUPERSET
        SUPERSET -> BILATERAL
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\data\Models.kt
=========================================

package com.example.gymtrack.core.data

// --- EXISTING LEGACY MODELS (Kept for UI compatibility) ---
data class Category(
    val name: String,
    val color: Long
)

val DEFAULT_CATEGORIES = listOf(
    Category("Push", 0xFFFF3B30),
    Category("Pull", 0xFFAF52DE),
    Category("Legs", 0xFF34C759),
)

val DEFAULT_CATEGORY_NAMES = DEFAULT_CATEGORIES.map { it.name }.toSet()

data class Settings(
    val is24Hour: Boolean = true,
    val roundingSeconds: Int = 5,
    val darkMode: Boolean = true,
    val categories: List<Category> = DEFAULT_CATEGORIES
)

data class NoteLine(
    val title: String,
    val text: String,
    val timestamp: Long,
    val categoryName: String? = null,
    val categoryColor: Long? = null,
    val learnings: String = ""
)

/**
 * Represents a raw workout note entry.
 * Required by StatsOverview and SetsDistributionChart.
 */
data class Note(
    val id: Int = 0,
    val text: String,        // Used by WorkoutParser in your charts
    val date: Long,
    val categoryName: String? = null
)

// --- NEW OBJECT-ORIENTED MODELS ---

/**
 * Represents a distinct exercise type (e.g., "Bench Press").
 * @param parentId Used for grouping variations (e.g., "Incline Bench" -> parent "Bench Press").
 * @param muscleGroup Primary target (e.g., "Chest", "Back").
 */
data class Exercise(
    val id: Long = 0,
    val name: String,
    val parentId: Long? = null,
    val muscleGroup: String? = null,
    val aliases: List<String> = emptyList() // Helps map "bp", "bench" -> "Bench Press"
)

/**
 * Represents a single performed set.
 * The core atom of your tracking.
 */
data class WorkoutSet(
    val id: Long = 0,
    val workoutId: Long,
    val exerciseId: Long, // Links to Exercise.id
    val weight: Float,
    val reps: Int,
    val rpe: Float? = null, // Rate of Perceived Exertion (optional)
    val isUnilateral: Boolean = false,
    val timestamp: Long // When this specific set happened
)

/**
 * A summarized view of a workout for a specific exercise.
 * Useful for your future graph cards (e.g., "Avg Sets per Exercise").
 */
data class ExerciseSessionSummary(
    val exerciseName: String,
    val totalSets: Int,
    val avgWeight: Float,
    val maxWeight: Float,
    val totalVolume: Float // sets * reps * weight
)


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\data\SettingsStore.kt
=========================================

package com.example.gymtrack.core.data

import android.content.Context
import androidx.datastore.preferences.core.booleanPreferencesKey
import androidx.datastore.preferences.core.edit
import androidx.datastore.preferences.core.intPreferencesKey
import androidx.datastore.preferences.core.stringPreferencesKey
import androidx.datastore.preferences.preferencesDataStore
import kotlinx.coroutines.flow.first

private val Context.settingsDataStore by preferencesDataStore("settings")

object SettingsStore {
    private val IS_24_HOUR = booleanPreferencesKey("is_24_hour")
    private val ROUNDING_SECONDS = intPreferencesKey("rounding_seconds")
    private val DARK_MODE = booleanPreferencesKey("dark_mode")
    private val CATEGORIES = stringPreferencesKey("categories")

    suspend fun load(context: Context): Settings {
        val prefs = context.settingsDataStore.data.first()
        val custom = prefs[CATEGORIES]?.takeIf { it.isNotEmpty() }?.split("|")?.map {
            val parts = it.split(":")
            val name = parts.getOrNull(0) ?: "Category"
            val color = parts.getOrNull(1)?.toLongOrNull() ?: 0L
            Category(name, color)
        } ?: emptyList()
        val cats = (custom + DEFAULT_CATEGORIES).distinctBy { it.name }

        return Settings(
            is24Hour = prefs[IS_24_HOUR] ?: true,
            roundingSeconds = prefs[ROUNDING_SECONDS] ?: 5,
            darkMode = prefs[DARK_MODE] ?: false,
            categories = cats
        )
    }

    suspend fun save(context: Context, settings: Settings) {
        context.settingsDataStore.edit { prefs ->
            val custom = settings.categories.filter { it.name !in DEFAULT_CATEGORY_NAMES }
            prefs[IS_24_HOUR] = settings.is24Hour
            prefs[ROUNDING_SECONDS] = settings.roundingSeconds
            prefs[DARK_MODE] = settings.darkMode
            prefs[CATEGORIES] = custom.joinToString("|") { "${it.name}:${it.color}" }
        }
    }
}



=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\data\WorkoutRepository.kt
=========================================

package com.example.gymtrack.core.data

import com.example.gymtrack.core.util.ParsedSetDTO
import com.example.gymtrack.core.util.WorkoutParser
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.first

class WorkoutRepository(
    private val noteDao: NoteDao,
    private val exerciseDao: ExerciseDao,
    private val setDao: SetDao
) {
    private val parser = WorkoutParser()

    fun getAllExercises(): Flow<List<ExerciseEntity>> {
        return exerciseDao.getAllExercises()
    }

    // Support both All-Time (0) and Time-Range filtering
    fun getExercisesSortedByCount(minTimestamp: Long = 0): Flow<List<ExerciseWithCount>> {
        return if (minTimestamp == 0L) {
            exerciseDao.getExercisesSortedByCount()
        } else {
            exerciseDao.getExercisesWithCountAfter(minTimestamp)
        }
    }

    fun getWeightHistory(exerciseId: Long): Flow<List<GraphPoint>> {
        return setDao.getAverageWeightHistory(exerciseId)
    }

    suspend fun cleanUpOrphans() {
        setDao.deleteOrphanedSets()
    }

    suspend fun deleteWorkout(timestamp: Long) {
        setDao.deleteSetsForWorkout(timestamp)
    }

    suspend fun saveParsedSets(sets: List<ParsedSetDTO>, workoutId: Long) {
        val setEntities = sets.map { set ->
            val exerciseId = resolveExerciseId(set.exerciseName)
            SetEntity(
                workoutId = workoutId,
                exerciseId = exerciseId,
                weight = set.weight,
                reps = set.reps,
                isUnilateral = set.isUnilateral,
                modifier = set.modifier,
                brand = set.brand,
                relativeTime = set.relativeTime,
                absoluteTime = set.absoluteTime
            )
        }
        setDao.replaceSetsForWorkout(workoutId, setEntities)
    }

    suspend fun syncNoteToWorkout(note: NoteEntity) {
        val parsedSets = parser.parseWorkout(note.text)
        saveParsedSets(parsedSets, note.timestamp)
    }

    // [FIX] New function to forcefully rebuild stats from Notes
    suspend fun forceUpdateStats() {
        val allNotes = noteDao.getAll().first()
        allNotes.forEach { note ->
            syncNoteToWorkout(note)
        }
    }

    // Keeps old check for first-run migration
    suspend fun checkAndMigrate() {
        val noteCount = noteDao.getCount()
        val setCount = setDao.getCount()
        if (noteCount > 0 && setCount == 0) {
            forceUpdateStats()
        }
    }

    private suspend fun resolveExerciseId(rawName: String): Long {
        if (rawName.isBlank()) return -1L
        val normalizedName = rawName.trim()
        val existing = exerciseDao.getByName(normalizedName)
        if (existing != null) return existing.exerciseId
        val aliasMatch = exerciseDao.findByAlias(normalizedName).firstOrNull()
        if (aliasMatch != null) return aliasMatch.exerciseId
        val newExercise = ExerciseEntity(name = normalizedName, aliases = "", muscleGroup = null)
        return exerciseDao.insert(newExercise)
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\services\NoteTimerService.kt
=========================================

package com.example.gymtrack.core.services

import android.app.Notification
import android.app.NotificationChannel
import android.app.NotificationManager
import android.app.Service
import android.content.Intent
import android.os.Build
import android.os.IBinder
import androidx.core.app.NotificationCompat
import com.example.gymtrack.R
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.Job
import kotlinx.coroutines.SupervisorJob
import kotlinx.coroutines.cancel
import kotlinx.coroutines.delay
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.isActive
import kotlinx.coroutines.launch

class NoteTimerService : Service() {
    private val scope = CoroutineScope(Dispatchers.Default + SupervisorJob())
    private var startTime = 0L
    private var elapsedBeforePause = 0L
    private var job = null as Job?

    override fun onBind(intent: Intent?): IBinder? = null

    override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {
        when (intent?.action) {
            ACTION_START -> {
                activeNoteTimestamp = intent.getLongExtra(EXTRA_NOTE, 0L)
                elapsedBeforePause = 0L
                startTimer()
            }
            ACTION_PAUSE -> pause()
            ACTION_RESUME -> resume()
            ACTION_STOP -> {
                stopTimer()
                stopSelf()
            }
        }
        return START_STICKY
    }

    private fun startTimer() {
        createNotificationChannel()
        startForeground(NOTIFICATION_ID, buildNotification(0))
        startTime = System.currentTimeMillis()
        job?.cancel()
        job = scope.launch {
            while (isActive) {
                val elapsed = elapsedBeforePause + ((System.currentTimeMillis() - startTime) / 1000)
                elapsedSeconds.value = elapsed
                val nm = getSystemService(NOTIFICATION_SERVICE) as NotificationManager
                nm.notify(NOTIFICATION_ID, buildNotification(elapsed))
                delay(1000)
            }
        }
        isRunning.value = true
    }

    private fun pause() {
        if (job == null) return
        job?.cancel()
        elapsedBeforePause = elapsedSeconds.value
        isRunning.value = false
    }

    private fun resume() {
        startTime = System.currentTimeMillis()
        job?.cancel()
        job = scope.launch {
            while (isActive) {
                val elapsed = elapsedBeforePause + ((System.currentTimeMillis() - startTime) / 1000)
                elapsedSeconds.value = elapsed
                val nm = getSystemService(NOTIFICATION_SERVICE) as NotificationManager
                nm.notify(NOTIFICATION_ID, buildNotification(elapsed))
                delay(1000)
            }
        }
        isRunning.value = true
    }

    private fun stopTimer() {
        job?.cancel()
        isRunning.value = false
        elapsedBeforePause = 0L
        elapsedSeconds.value = 0L
        activeNoteTimestamp = null
        stopForeground(true)
    }

    override fun onDestroy() {
        super.onDestroy()
        scope.cancel()
    }

    private fun buildNotification(elapsed: Long): Notification {
        val minutes = elapsed / 60
        val seconds = elapsed % 60
        val text = String.format("%02d:%02d", minutes, seconds)
        return NotificationCompat.Builder(this, CHANNEL_ID)
            .setContentTitle("Note Timer")
            .setContentText(text)
            .setSmallIcon(R.drawable.ic_gymtrack_logo)
            .setOngoing(true)
            .build()
    }

    private fun createNotificationChannel() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            val channel = NotificationChannel(
                CHANNEL_ID,
                "Note Timer",
                NotificationManager.IMPORTANCE_LOW
            )
            val nm = getSystemService(NOTIFICATION_SERVICE) as NotificationManager
            nm.createNotificationChannel(channel)
        }
    }

    companion object {
        const val ACTION_START = "com.example.gymtrack.timer.START"
        const val ACTION_PAUSE = "com.example.gymtrack.timer.PAUSE"
        const val ACTION_RESUME = "com.example.gymtrack.timer.RESUME"
        const val ACTION_STOP = "com.example.gymtrack.timer.STOP"
        const val EXTRA_NOTE = "extra_note_timestamp"
        val elapsedSeconds = MutableStateFlow(0L)
        val isRunning = MutableStateFlow(false)
        var activeNoteTimestamp: Long? = null
        private const val CHANNEL_ID = "note_timer"
        private const val NOTIFICATION_ID = 42
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\ui\components\ColorDropdown.kt
=========================================

package com.example.gymtrack.core.ui.components

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.size
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.unit.dp
import com.example.gymtrack.core.util.presetColors

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun ColorDropdown(
    selected: Long,
    modifier: Modifier = Modifier,
    label: String = "Color",
    onSelected: (Long) -> Unit,
) {
    var expanded by remember { mutableStateOf(false) }
    ExposedDropdownMenuBox(expanded = expanded, onExpandedChange = { expanded = !expanded }) {
        OutlinedTextField(
            readOnly = true,
            value = String.format("#%06X", 0xFFFFFF and selected.toInt()),
            onValueChange = {},
            colors = OutlinedTextFieldDefaults.colors(
                focusedBorderColor = MaterialTheme.colorScheme.background,
                unfocusedBorderColor = MaterialTheme.colorScheme.background,
                cursorColor = MaterialTheme.colorScheme.onSurface,
            ),
            modifier = modifier.menuAnchor(),
            label = { Text(label) },
            leadingIcon = {
                Box(
                    Modifier
                        .size(16.dp)
                        .background(Color(selected.toInt()))
                )
            },
            trailingIcon = { ExposedDropdownMenuDefaults.TrailingIcon(expanded) },
        )
        DropdownMenu(expanded = expanded, onDismissRequest = { expanded = false }) {
            presetColors.forEach { color ->
                DropdownMenuItem(
                    text = {
                        Box(
                            Modifier
                                .size(24.dp)
                                .background(Color(color.toInt()))
                        )
                    },
                    onClick = { onSelected(color); expanded = false },
                )
            }
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\ui\theme\Color.kt
=========================================

package com.example.gymtrack.core.ui.theme

import androidx.compose.ui.graphics.Color

// Spotify-inspired Dark Theme Palette
val SpotBlack = Color(0xFF121212)       // Main Background
val SpotDarkGray = Color(0xFF212121)    // Card Surface
val SpotLightGray = Color(0xFF535353)   // Secondary Text
val SpotWhite = Color(0xFFFFFFFF)       // Primary Text
val SpotGreen = Color(0xFF1DB954)       // Primary Action (GymTrack Green)

// Category Gradients (For "Album Art" look)
val PushGradient = listOf(Color(0xFFFF3B30), Color(0xFF991812))
val PullGradient = listOf(Color(0xFFAF52DE), Color(0xFF5E187F))
val LegsGradient = listOf(Color(0xFF34C759), Color(0xFF0F5720))
val DefaultGradient = listOf(Color(0xFF535353), Color(0xFF121212))

// --- DARK MODE (Apple "Midnight" Style) ---
val AppleBlack = Color(0xFF000000)       // Background
val AppleDarkGray = Color(0xFF1C1C1E)    // Cards/Surface
val TextWhite = Color(0xFFFFFFFF)
val TextGray = Color(0xFF8E8E93)

// --- LIGHT MODE (Apple "Standard" Style) ---
val AppleWhite = Color(0xFFF2F2F7)       // Background (Subtle off-white)
val AppleLightCard = Color(0xFFFFFFFF)   // Cards (Pure white)
val TextBlack = Color(0xFF000000)

// --- ACCENTS (Shared) ---
val NeonGreen = Color(0xFF34C759)
val NeonRed = Color(0xFFFF3B30)
val NeonPurple = Color(0xFFAF52DE)
val SupersetBlue = Color(0xFF64B5F6)
// Helpers
fun Color.darken(factor: Float): Color {
    return Color(
        red = (red * (1 - factor)).coerceIn(0f, 1f),
        green = (green * (1 - factor)).coerceIn(0f, 1f),
        blue = (blue * (1 - factor)).coerceIn(0f, 1f),
        alpha = alpha,
    )
}

fun Color.lighten(factor: Float): Color {
    return Color(
        red = (red + (1 - red) * factor).coerceIn(0f, 1f),
        green = (green + (1 - green) * factor).coerceIn(0f, 1f),
        blue = (blue + (1 - blue) * factor).coerceIn(0f, 1f),
        alpha = alpha,
    )
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\ui\theme\Shape.kt
=========================================

package com.example.gymtrack.core.ui.theme

import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Shapes
import androidx.compose.ui.unit.dp

val AppShapes = Shapes(
    small = RoundedCornerShape(10.dp),
    medium = RoundedCornerShape(20.dp),
    large = RoundedCornerShape(30.dp)
)



=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\ui\theme\Theme.kt
=========================================

package com.example.gymtrack.core.ui.theme

import androidx.compose.foundation.isSystemInDarkTheme
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.darkColorScheme
import androidx.compose.material3.lightColorScheme
import androidx.compose.runtime.Composable
import androidx.compose.runtime.CompositionLocalProvider
import androidx.compose.foundation.text.selection.LocalTextSelectionColors
import androidx.compose.foundation.text.selection.TextSelectionColors

private val DarkColorScheme = darkColorScheme(
    primary = SpotGreen,
    background = SpotBlack,
    surface = SpotDarkGray,
    onPrimary = SpotBlack,
    onSurface = SpotWhite,
    onBackground = SpotWhite
)

private val LightColorScheme = lightColorScheme(
    primary = AppleBlack,
    onPrimary = TextWhite,
    secondary = NeonGreen,
    background = AppleWhite,        // <--- Apple style Light Gray background
    surface = AppleLightCard,       // <--- White cards
    surfaceVariant = AppleWhite,
    onSurface = TextBlack,
    onBackground = TextBlack
)

@Composable
fun GymTrackTheme(
    darkTheme: Boolean = isSystemInDarkTheme(),
    content: @Composable () -> Unit
) {
    val colorScheme = if (darkTheme) DarkColorScheme else LightColorScheme

    val selectionColors = TextSelectionColors(
        handleColor = NeonGreen,
        backgroundColor = NeonGreen.copy(alpha = 0.4f)
    )

    CompositionLocalProvider(LocalTextSelectionColors provides selectionColors) {
        MaterialTheme(
            colorScheme = colorScheme,
            typography = Typography,
            shapes = AppShapes,
            content = content
        )
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\ui\theme\Type.kt
=========================================

package com.example.gymtrack.core.ui.theme

import androidx.compose.material3.Typography
import androidx.compose.ui.text.TextStyle
import androidx.compose.ui.text.font.FontFamily
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.sp

// Set of Material typography styles to start with
val Typography = Typography(
    bodyLarge = TextStyle(
        fontFamily = FontFamily.SansSerif,
        fontWeight = FontWeight.Normal,
        fontSize = 16.sp,
        lineHeight = 24.sp,
        letterSpacing = 0.5.sp
    ),
    titleLarge = TextStyle(
        fontFamily = FontFamily.SansSerif,
        fontWeight = FontWeight.SemiBold,
        fontSize = 22.sp,
        lineHeight = 28.sp,
        letterSpacing = 0.sp
    )
)


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\util\BulletListTransformation.kt
=========================================

package com.example.gymtrack.core.util

import androidx.compose.runtime.Composable
import androidx.compose.runtime.remember
import androidx.compose.ui.text.AnnotatedString
import androidx.compose.ui.text.input.OffsetMapping
import androidx.compose.ui.text.input.TransformedText
import androidx.compose.ui.text.input.VisualTransformation

/**
 * VisualTransformation that prepends a bullet to each line of text.
 * Used for displaying learnings as a bullet list without modifying the content.
 */
class BulletListTransformation(private val bullet: String = "\u2022") : VisualTransformation {
    private val prefix = "$bullet "

    override fun filter(text: AnnotatedString): TransformedText {
        val original = text.text
        val lines = original.split('\n')
        val transformed = buildString {
            lines.forEachIndexed { idx, line ->
                append(prefix)
                append(line)
                if (idx != lines.lastIndex) append('\n')
            }
        }
        val bulletLen = prefix.length
        val offsetMapping = object : OffsetMapping {
            override fun originalToTransformed(offset: Int): Int {
                val before = original.substring(0, offset)
                val lineBreaks = before.count { it == '\n' }
                return offset + bulletLen * (lineBreaks + 1)
            }

            override fun transformedToOriginal(offset: Int): Int {
                if (offset <= bulletLen) return 0
                var orig = 0
                var trans = bulletLen
                while (orig < original.length && trans < offset) {
                    if (original[orig] == '\n') {
                        orig++
                        trans++ // newline
                        if (trans >= offset) break
                        trans += bulletLen
                    } else {
                        orig++
                        trans++
                    }
                }
                return orig
            }
        }
        return TransformedText(AnnotatedString(transformed), offsetMapping)
    }
}

@Composable
fun rememberBulletListTransformation(): VisualTransformation {
    return remember { BulletListTransformation() }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\util\ColorUtils.kt
=========================================

package com.example.gymtrack.core.util

import androidx.compose.ui.graphics.Color

val presetColors = listOf(
    0xFFE57373,
    0xFF64B5F6,
    0xFF81C784,
    0xFFFFB74D,
    0xFFBA68C8,
    0xFFA1887F,
)

fun Color.darken(factor: Float): Color {
    return Color(
        red = (red * (1 - factor)).coerceIn(0f, 1f),
        green = (green * (1 - factor)).coerceIn(0f, 1f),
        blue = (blue * (1 - factor)).coerceIn(0f, 1f),
        alpha = alpha,
    )
}

fun Color.lighten(factor: Float): Color {
    return Color(
        red = (red + (1 - red) * factor).coerceIn(0f, 1f),
        green = (green + (1 - green) * factor).coerceIn(0f, 1f),
        blue = (blue + (1 - blue) * factor).coerceIn(0f, 1f),
        alpha = alpha,
    )
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\util\DateUtils.kt
=========================================

package com.example.gymtrack.core.util

import com.example.gymtrack.core.data.Settings
import java.text.SimpleDateFormat
import java.util.*

// --- EXISTING FORMATTERS ---

fun parseDurationSeconds(str: String): Int {
    val primeRegex = "(\\d+)'(\\d{2})''".toRegex()
    primeRegex.matchEntire(str)?.let {
        val minutes = it.groupValues[1].toInt()
        val seconds = it.groupValues[2].toInt()
        return minutes * 60 + seconds
    }

    val hmsRegex = "(\\d{1,2}):(\\d{2}):(\\d{2})".toRegex()
    hmsRegex.matchEntire(str)?.let {
        val h = it.groupValues[1].toInt()
        val m = it.groupValues[2].toInt()
        val s = it.groupValues[3].toInt()
        return h * 3600 + m * 60 + s
    }

    val hmRegex = "(\\d{1,2}):(\\d{2})".toRegex()
    hmRegex.matchEntire(str)?.let {
        val h = it.groupValues[1].toInt()
        val m = it.groupValues[2].toInt()
        return h * 3600 + m * 60
    }

    return str.removeSuffix("s").toIntOrNull() ?: 0
}

fun formatWeekRelativeTime(timestamp: Long, settings: Settings): String {
    val nowCal = Calendar.getInstance().apply {
        firstDayOfWeek = Calendar.MONDAY
        minimalDaysInFirstWeek = 4
    }
    val dateCal = Calendar.getInstance().apply {
        timeInMillis = timestamp
        firstDayOfWeek = Calendar.MONDAY
        minimalDaysInFirstWeek = 4
    }

    val timeFormat = SimpleDateFormat(
        if (settings.is24Hour) "HH:mm" else "hh:mm a",
        Locale.getDefault()
    )
    val dayNameFormat = SimpleDateFormat("EEEE", Locale.getDefault())
    val fullFormat = SimpleDateFormat(
        if (settings.is24Hour) "dd/MM/yyyy HH:mm" else "dd/MM/yyyy hh:mm a",
        Locale.getDefault()
    )

    val sameDay = nowCal.get(Calendar.YEAR) == dateCal.get(Calendar.YEAR) &&
            nowCal.get(Calendar.DAY_OF_YEAR) == dateCal.get(Calendar.DAY_OF_YEAR)

    val yesterdayCal = (nowCal.clone() as Calendar).apply { add(Calendar.DAY_OF_YEAR, -1) }
    val isYesterday = yesterdayCal.get(Calendar.YEAR) == dateCal.get(Calendar.YEAR) &&
            yesterdayCal.get(Calendar.DAY_OF_YEAR) == dateCal.get(Calendar.DAY_OF_YEAR)

    // â€œLast 7 daysâ€ window (exclusive of Today/Yesterday checks above)
    val sevenDaysAgo = (nowCal.clone() as Calendar).apply { add(Calendar.DAY_OF_YEAR, -7) }
    val withinLast7Days = dateCal.after(sevenDaysAgo) && !sameDay && !isYesterday

    val sameWeek = nowCal.get(Calendar.YEAR) == dateCal.get(Calendar.YEAR) &&
            nowCal.get(Calendar.WEEK_OF_YEAR) == dateCal.get(Calendar.WEEK_OF_YEAR)

    return when {
        sameDay -> "Today ${timeFormat.format(dateCal.time)}"
        isYesterday -> "Yesterday ${timeFormat.format(dateCal.time)}"
        withinLast7Days -> "${dayNameFormat.format(dateCal.time)} ${timeFormat.format(dateCal.time)}"
        sameWeek -> "${dayNameFormat.format(dateCal.time)} ${timeFormat.format(dateCal.time)}"
        else -> fullFormat.format(dateCal.time)
    }
}

fun formatFullDateTime(timestamp: Long, settings: Settings): String {
    val pattern = if (settings.is24Hour) "dd/MM/yyyy HH:mm" else "dd/MM/yyyy hh:mm a"
    val format = SimpleDateFormat(pattern, Locale.getDefault())
    return format.format(Date(timestamp))
}

fun parseFullDateTime(value: String): Long {
    val patterns = listOf("dd/MM/yyyy HH:mm", "dd/MM/yyyy hh:mm a")
    for (p in patterns) {
        try {
            val format = SimpleDateFormat(p, Locale.getDefault())
            val date = format.parse(value)
            if (date != null) return date.time
        } catch (_: Exception) {
        }
    }
    return 0L
}


fun formatRelativeTime(timestamp: Long, settings: Settings): String {
    val now = System.currentTimeMillis()
    val diff = now - timestamp
    val date = Date(timestamp)
    val timeFormat =
        SimpleDateFormat(if (settings.is24Hour) "HH:mm" else "hh:mm a", Locale.getDefault())
    val fullFormat = SimpleDateFormat(
        if (settings.is24Hour) "dd MMM HH:mm" else "dd MMM hh:mm a",
        Locale.getDefault(),
    )

    return when {
        diff < 60_000 -> "Just now"
        diff < 86_400_000 -> "Today ${timeFormat.format(date)}"
        diff < 172_800_000 -> "Yesterday ${timeFormat.format(date)}"
        else -> fullFormat.format(date)
    }
}

fun formatRoundedTime(timestamp: Long, settings: Settings): String {
    val rounding = settings.roundingSeconds.coerceAtLeast(1) * 1000L
    val rounded = ((timestamp + rounding / 2) / rounding) * rounding
    val pattern = if (settings.is24Hour) "HH:mm:ss" else "hh:mm:ss a"
    val format = SimpleDateFormat(pattern, Locale.getDefault())
    return format.format(Date(rounded))
}

fun formatElapsedMinutesSeconds(
    start: Long,
    now: Long,
    settings: Settings,
): String {
    val rounding = settings.roundingSeconds.coerceAtLeast(1) * 1000L
    var diff = now - start
    diff = ((diff + rounding / 2) / rounding) * rounding
    val totalSeconds = diff / 1000
    return formatSecondsToMinutesSeconds(totalSeconds)
}

fun formatTime(timestamp: Long, settings: Settings): String {
    val pattern = if (settings.is24Hour) "HH:mm" else "hh:mm a"
    val format = SimpleDateFormat(pattern, Locale.getDefault())
    return format.format(Date(timestamp))
}

fun formatDate(timestamp: Long, settings: Settings): String {
    val pattern = "dd/MM/yyyy"
    val format = SimpleDateFormat(pattern, Locale.getDefault())
    return format.format(Date(timestamp))
}


fun formatSecondsToMinutesSeconds(seconds: Long): String {
    val minutes = seconds / 60
    val sec = seconds % 60
    return "${minutes}'${sec.toString().padStart(2, '0')}''"
}

// --- NEW HELPER FUNCTIONS FOR RELATIVE TIME LOGIC ---

/**
 * Parses a time string (HH:mm:ss, HH:mm, or mm'ss'') into milliseconds.
 * Returns null if parsing fails or string is empty.
 */
fun parseTimeOrDuration(timeStr: String): Long? {
    if (timeStr.isBlank()) return null

    try {
        // Case A: Relative duration format "mm'ss''"
        if (timeStr.contains("'")) {
            val parts = timeStr.replace("''", "").split("'")
            val min = parts.getOrNull(0)?.toLongOrNull() ?: 0L
            val sec = parts.getOrNull(1)?.toLongOrNull() ?: 0L
            // Return duration in millis
            return (min * 60 + sec) * 1000L
        }

        // Case B: Absolute wall clock "HH:mm:ss"
        // Strip potential AM/PM or extra dates
        val cleanTime = timeStr.trim().split(" ")[0]
        val parts = cleanTime.split(":")

        val hours = parts.getOrNull(0)?.toLongOrNull() ?: 0L
        val minutes = parts.getOrNull(1)?.toLongOrNull() ?: 0L
        val seconds = parts.getOrNull(2)?.toLongOrNull() ?: 0L

        // Return millis into the day
        return (hours * 3600 + minutes * 60 + seconds) * 1000L

    } catch (e: Exception) {
        return null
    }
}

/**
 * Calculates the difference between a previous time string and the current system time.
 * Returns the formatted string "(m'ss'')" to be inserted into the note.
 */
fun getRelativeTimeDiffString(prevTimeStr: String, currentTimeMillis: Long): String? {
    val prevMillis = parseTimeOrDuration(prevTimeStr) ?: return null

    // Convert current time to "millis into the day" to match the parsed format
    val cal = Calendar.getInstance().apply { timeInMillis = currentTimeMillis }
    val currentMillisIntoDay = (cal.get(Calendar.HOUR_OF_DAY) * 3600 +
            cal.get(Calendar.MINUTE) * 60 +
            cal.get(Calendar.SECOND)) * 1000L

    var diff = currentMillisIntoDay - prevMillis

    // Handle midnight rollover
    if (diff < 0) {
        diff += 24 * 3600 * 1000L
    }

    // Convert diff to seconds
    val totalSeconds = diff / 1000
    if (totalSeconds < 0) return null

    val minutes = totalSeconds / 60
    val seconds = totalSeconds % 60

    // Format as (m'ss'')
    return String.format("(%d'%02d'')", minutes, seconds)
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\util\ExportUtils.kt
=========================================

package com.example.gymtrack.core.util

import android.content.ContentValues
import android.content.Context
import android.os.Build
import android.os.Environment
import android.provider.MediaStore
import com.example.gymtrack.core.data.NoteLine
import com.example.gymtrack.core.data.Settings
import com.example.gymtrack.core.data.ExerciseFlag
import java.io.File
import java.text.SimpleDateFormat
import java.util.Date
import java.util.Locale

data class SubEntry(val parent: Int, val text: String, val time: String, val flag: ExerciseFlag)

private fun csvEscape(value: String): String {
    var v = value.replace("\"", "\"\"")
    if (v.contains(',') || v.contains('"') || v.contains('\n')) {
        v = "\"$v\""
    }
    return v
}

private fun ExerciseFlag.toCsvString(): String = when (this) {
    ExerciseFlag.BILATERAL -> "bi"
    ExerciseFlag.UNILATERAL -> "uni"
    ExerciseFlag.SUPERSET -> "SS"
}

private fun ExerciseFlag.toSubEntryString(): String = when (this) {
    ExerciseFlag.BILATERAL -> "1x"
    ExerciseFlag.UNILATERAL -> "2x"
    ExerciseFlag.SUPERSET -> "2x"
}

private fun parseFlag(value: String?): ExerciseFlag = when (value?.lowercase()) {
    "uni" -> ExerciseFlag.UNILATERAL
    "ss" -> ExerciseFlag.SUPERSET
    "2x" -> ExerciseFlag.UNILATERAL
    "1x" -> ExerciseFlag.BILATERAL
    else -> ExerciseFlag.BILATERAL
}

fun exportNote(context: Context, note: NoteLine, settings: Settings): File {
    val parsed = parseNoteText(note.text)

    val main = mutableListOf<Triple<String, String, ExerciseFlag>>()
    val subs = mutableListOf<SubEntry>()

    var currentMain = -1
    parsed.first.forEachIndexed { idx, line ->
        val time = parsed.second.getOrNull(idx).orEmpty()
        val flag = parsed.third.getOrNull(idx) ?: ExerciseFlag.BILATERAL
        if (line.isBlank()) return@forEachIndexed
        if (line.startsWith("    ")) {
            if (currentMain >= 0) {
                val parentFlag = main.getOrNull(currentMain)?.third ?: ExerciseFlag.BILATERAL
                subs += SubEntry(currentMain, line.trim(), time, parentFlag)
            }
        } else {
            currentMain = main.size
            main += Triple(line.trim(), time, flag)
        }
    }

    val builder = StringBuilder()
    builder.append("Title,Category,Timestamp,Learnings\n")
    builder.append(csvEscape(note.title)).append(',')
        .append(csvEscape(note.categoryName ?: "")).append(',')
        .append(csvEscape(formatFullDateTime(note.timestamp, settings))).append(',')
        .append(csvEscape(note.learnings)).append('\n')

    builder.append("Main Index,Main Entry,Time,Flag\n")
    main.forEachIndexed { index, (text, time, flag) ->
        builder.append(index).append(',')
            .append(csvEscape(text)).append(',')
            .append(csvEscape(time)).append(',')
            .append(flag.toCsvString()).append('\n')
    }

    builder.append("Main Index,Sub Entry,Time,Flag\n")
    subs.forEach { (index, text, time, flag) ->
        builder.append(index).append(',')
            .append(csvEscape(text)).append(',')
            .append(csvEscape(time)).append(',')
            .append(flag.toSubEntryString()).append('\n')
    }

    val dir = File(context.filesDir, "csv").apply { mkdirs() }
    val safeTitle = note.title
        .trim()
        .replace(" ", "_")
        .replace(Regex("[^A-Za-z0-9_-]"), "")
        .ifEmpty { "note" }
    val date = SimpleDateFormat("dd-MM-yy", Locale.getDefault())
        .format(Date(note.timestamp))
    val time = SimpleDateFormat("HH-mm", Locale.getDefault())
        .format(Date(note.timestamp))
    val file = File(dir, "${safeTitle}-$date-$time.csv")
    file.writeText(builder.toString())

    // Also copy to public Downloads directory if writable
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
        val contentValues = ContentValues().apply {
            put(MediaStore.MediaColumns.DISPLAY_NAME, file.name)
            put(MediaStore.MediaColumns.MIME_TYPE, "text/csv")
            put(MediaStore.MediaColumns.RELATIVE_PATH, Environment.DIRECTORY_DOWNLOADS)
        }

        val resolver = context.contentResolver
        val uri = resolver.insert(MediaStore.Downloads.EXTERNAL_CONTENT_URI, contentValues)

        if (uri != null) {
            try {
                resolver.openOutputStream(uri)?.use { output ->
                    file.inputStream().use { input ->
                        input.copyTo(output)
                    }
                }
            } catch (e: Exception) {
                e.printStackTrace() // Log failure
            }
        }
    }

    return file
}

fun getSavedCsvFiles(context: Context): List<File> {
    val dir = File(context.filesDir, "csv")
    return dir.listFiles()?.filter { it.extension == "csv" }?.sortedBy { it.name } ?: emptyList()
}

fun parseCsvRow(row: String): List<String> {
    val result = mutableListOf<String>()
    var current = StringBuilder()
    var inQuotes = false
    var i = 0
    while (i < row.length) {
        val c = row[i]
        when (c) {
            '"' -> {
                if (inQuotes && i + 1 < row.length && row[i + 1] == '"') {
                    current.append('"')
                    i++
                } else {
                    inQuotes = !inQuotes
                }
            }

            ',' -> {
                if (inQuotes) current.append(c) else {
                    result += current.toString()
                    current = StringBuilder()
                }
            }

            else -> current.append(c)
        }
        i++
    }
    result += current.toString()
    return result
}

fun importNote(file: File, settings: Settings): NoteLine? {
    val lines = file.readLines()
    if (lines.size < 2) return null

    val metaRow = parseCsvRow(lines[1])
    val title = metaRow.getOrNull(0) ?: ""
    val category = metaRow.getOrNull(1).takeUnless { it.isNullOrEmpty() }
    val timestampStr = metaRow.getOrNull(2) ?: return null
    val learnings = metaRow.getOrNull(3) ?: ""

    var idx = 2
    while (idx < lines.size && lines[idx].isBlank()) idx++
    if (idx >= lines.size) return null

    val main = mutableListOf<Triple<String, String, ExerciseFlag>>()

    if (lines[idx].trimStart().startsWith("Main Entry")) {
        val hasFlag = parseCsvRow(lines[idx]).any { it.trim().equals("Flag", true) || it.trim().equals("Uni", true) }
        idx++
        while (idx < lines.size && !lines[idx].trimStart().startsWith("Main Index")) {
            val row = parseCsvRow(lines[idx])
            val text = row.getOrNull(0).orEmpty()
            val time = row.getOrNull(1).orEmpty()
            val flag = if (hasFlag) parseFlag(row.getOrNull(2)) else ExerciseFlag.BILATERAL
            if (text.isNotBlank() || time.isNotBlank()) main += Triple(text, time, flag)
            idx++
        }
    } else if (lines[idx].trimStart().startsWith("Main Index")) {
        val header = parseCsvRow(lines[idx])
        val secondCol = header.getOrNull(1)?.trim()?.lowercase()
        if (secondCol != "main entry") return null
        val hasFlag = header.any { it.trim().equals("Flag", true) || it.trim().equals("Uni", true) }
        idx++
        while (idx < lines.size) {
            if (lines[idx].trimStart().startsWith("Main Index") &&
                parseCsvRow(lines[idx]).getOrNull(1)?.trim()?.equals("Sub Entry", true) == true) break
            val row = parseCsvRow(lines[idx])
            val text = row.getOrNull(1).orEmpty()
            val time = row.getOrNull(2).orEmpty()
            val flag = if (hasFlag) parseFlag(row.getOrNull(3)) else ExerciseFlag.BILATERAL
            if (text.isNotBlank() || time.isNotBlank()) main += Triple(text, time, flag)
            idx++
        }
    } else return null

    val subs = mutableListOf<SubEntry>()
    if (idx < lines.size && lines[idx].trimStart().startsWith("Main Index")) {
        val header = parseCsvRow(lines[idx])
        val hasFlag = header.any { it.trim().equals("Flag", true) || it.trim().equals("Uni", true) }
        idx++
        while (idx < lines.size) {
            val row = parseCsvRow(lines[idx])
            val parent = row.getOrNull(0)?.toIntOrNull() ?: -1
            val text = row.getOrNull(1).orEmpty()
            val time = row.getOrNull(2).orEmpty()
            val flag = if (hasFlag) parseFlag(row.getOrNull(3)) else ExerciseFlag.BILATERAL
            if (parent >= 0) subs += SubEntry(parent, text, time, flag)
            idx++
        }
    }

    val bodyLines = mutableListOf<String>()
    val times = mutableListOf<String>()
    val flags = mutableListOf<ExerciseFlag>()
    main.forEachIndexed { i, (text, time, flag) ->
        if (i > 0) {
            bodyLines += ""
            times += ""
            flags += ExerciseFlag.BILATERAL
        }
        bodyLines += text
        times += time
        flags += flag
        subs.filter { it.parent == i }.forEach { (_, sText, sTime, _) ->
            bodyLines += "    $sText"
            times += sTime
            flags += flag
        }
    }

    val fullText = combineTextAndTimes(bodyLines.joinToString("\n"), times, flags)
    val time = parseFullDateTime(timestampStr)
    return NoteLine(title, fullText, time, category, null, learnings)
}



=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\util\ImportUtils.kt
=========================================

package com.example.gymtrack.core.util

fun importAndProcessCsv(
    csvRows: List<String>,
    parser: WorkoutParser,
    workoutTimestamp: Long // ID for the entire workout
): List<ParsedSetDTO> {

    val finalSetsToSave = mutableListOf<ParsedSetDTO>()

    var currentExerciseIndex = -1
    var lastWeight = 0f

    // We start processing from the beginning and rely on robust filtering inside the loop.
    val dataRows = csvRows

    dataRows.forEach { rowString ->

        // 1. Robust Row Filtering: Skip blank lines and known text headers immediately.
        if (rowString.isBlank() || rowString.startsWith("Title,") || rowString.startsWith("Main Index,")) {
            return@forEach
        }

        // --- Core Row Split ---
        val csvRow = parseCsvRow(rowString)

        // 2. Column Count Check: Must have at least the index and set details.
        if (csvRow.size < 2) return@forEach

        val exerciseIndexStr = csvRow[0].trim()
        val setDetailsText = csvRow[1].trim()

        // 3. Index Validity Check: Ensure the first column is a valid exercise index number.
        val newIndex = exerciseIndexStr.toIntOrNull()

        if (newIndex == null || newIndex < 0) {
            return@forEach // Skip row if index is null (text) or negative
        }

        // --- 4. Check for Exercise Group Change (State Reset) ---
        if (newIndex != currentExerciseIndex) {
            currentExerciseIndex = newIndex
            lastWeight = 0f // Reset weight memory for a new exercise group
        }

        // --- 5. Core Parsing and Stateful Carry-Over ---

        // The parser logic is designed for text blobs, so we feed it the relevant cell content.
        // We ensure we only run the parser if there is actual set text.
        if (setDetailsText.isNotBlank()) {
            val parsedSetList = parser.parseWorkout(setDetailsText)

            parsedSetList.forEach { set ->

                if (set.weight > 0f) {
                    lastWeight = set.weight // Store the new weight
                } else if (set.reps > 0) {
                    // If weight is 0 but reps exist, apply carry-over logic
                    set.weight = lastWeight
                }

                // Assign the workout ID and save the corrected set data
                finalSetsToSave.add(set.copy(workoutId = workoutTimestamp))
            }
        }
    }

    return finalSetsToSave
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\util\RelativeTimeVisualTransformation.kt
=========================================

package com.example.gymtrack.core.util

import androidx.compose.foundation.isSystemInDarkTheme
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.Composable
import androidx.compose.runtime.remember
import androidx.compose.ui.text.AnnotatedString
import androidx.compose.ui.text.SpanStyle
import androidx.compose.ui.text.input.OffsetMapping
import androidx.compose.ui.text.input.TransformedText
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.input.VisualTransformation
import androidx.compose.ui.unit.TextUnit

/**
 * VisualTransformation that highlights relative times like "(00'30'')" within the text.
 */
class RelativeTimeVisualTransformation(private val color: Color, private val fontSize: TextUnit) :
    VisualTransformation {
    private val pattern = "\\((?:\\d+'\\d{2}''|\\d+s)\\)".toRegex()
    private val secondsTrans = SmallSecondsVisualTransformation(fontSize)

    override fun filter(text: AnnotatedString): TransformedText {
        val withSeconds = secondsTrans.filter(text).text
        val builder = AnnotatedString.Builder(withSeconds)
        pattern.findAll(withSeconds.text).forEach { match ->
            builder.addStyle(
                SpanStyle(color = color),
                match.range.first,
                match.range.last + 1
            )
        }
        return TransformedText(builder.toAnnotatedString(), OffsetMapping.Identity)
    }
}

@Composable
fun rememberRelativeTimeVisualTransformation(fontSize: TextUnit): RelativeTimeVisualTransformation {
    val color = MaterialTheme.colorScheme.onSurface
    val tint = color.copy(alpha = if (isSystemInDarkTheme()) 0.75f else 0.45f)
    return remember(tint) { RelativeTimeVisualTransformation(tint, fontSize) }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\util\SmallSecondsVisualTransformation.kt
=========================================

package com.example.gymtrack.core.util

import androidx.compose.runtime.Composable
import androidx.compose.runtime.remember
import androidx.compose.ui.text.AnnotatedString
import androidx.compose.ui.text.SpanStyle
import androidx.compose.ui.text.input.OffsetMapping
import androidx.compose.ui.text.input.TransformedText
import androidx.compose.ui.text.input.VisualTransformation
import androidx.compose.ui.text.style.BaselineShift
import androidx.compose.ui.unit.TextUnit

/**
 * VisualTransformation that makes the seconds portion of a time string smaller
 * and raised. Works with patterns like "0'05''".
 */
class SmallSecondsVisualTransformation(
    private val baseFontSize: TextUnit
) : VisualTransformation {

    private val timePattern = "\\d+'\\d{2}''".toRegex()

    override fun filter(text: AnnotatedString): TransformedText {
        val builder = AnnotatedString.Builder(text)

        timePattern.findAll(text.text).forEach { match ->
            val value = match.value
            val firstPrime = value.indexOf("'")
            if (firstPrime != -1 && value.endsWith("''")) {
                val secStart = match.range.first + firstPrime + 1
                val secEnd = secStart + 2
                builder.addStyle(
                    SpanStyle(
                        fontSize = baseFontSize * 0.75f,
                        baselineShift = BaselineShift(0.20f),
                    ),
                    secStart,
                    secEnd,
                )
            }
        }

        return TransformedText(builder.toAnnotatedString(), OffsetMapping.Identity)
    }
}

@Composable
fun rememberSmallSecondsVisualTransformation(fontSize: TextUnit): VisualTransformation {
    return remember(fontSize) { SmallSecondsVisualTransformation(fontSize) }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\util\TextUtils.kt
=========================================

package com.example.gymtrack.core.util

import androidx.compose.ui.text.AnnotatedString
import androidx.compose.ui.text.input.OffsetMapping
import androidx.compose.ui.text.input.TransformedText
import androidx.compose.ui.text.input.VisualTransformation
import com.example.gymtrack.core.data.ExerciseFlag
import java.util.Locale

// Regex to detect the "broken" format: ends with time (e.g. 0'00") followed by a flag code (b/u/s)
// Captures: Group 1 (Body), Group 2 (Time), Group 3 (Flag)
private val DIRTY_TAIL_REGEX = Regex("""^(.*?)(\d+'\d{2}(?:''|")?)([bus])$""")

private const val SEP = '\u200B'   // invisible separator for ABS time
private const val FLAG_SEP = '\u200C' // separator for exercise flag

fun parseNoteText(text: String): Triple<List<String>, List<String>, List<ExerciseFlag>> {
    if (text.isEmpty()) return Triple(emptyList(), emptyList(), emptyList())

    val body   = mutableListOf<String>()
    val absCol = mutableListOf<String>()
    val flagCol = mutableListOf<ExerciseFlag>()

    for (l in text.split('\n')) {
        var line = l.trimEnd() // Remove trailing spaces

        // Skip lines that are just a flag code (ghost lines from the bug)
        if (line == "b" || line == "u" || line == "s") continue

        var flag = ExerciseFlag.BILATERAL
        var absTime = ""
        var cleanBody = line

        // 1. Try Standard Parsing (Invisible Separators)
        val flagCut = line.lastIndexOf(FLAG_SEP)
        if (flagCut != -1) {
            flag = when (line.substring(flagCut + 1)) {
                "u" -> ExerciseFlag.UNILATERAL
                "s" -> ExerciseFlag.SUPERSET
                else -> ExerciseFlag.BILATERAL
            }
            cleanBody = line.substring(0, flagCut)

            val cut = cleanBody.lastIndexOf(SEP)
            if (cut != -1) {
                absTime = cleanBody.substring(cut + 1)
                cleanBody = cleanBody.substring(0, cut)
            }
        }
        // 2. Fallback: Try "Dirty" Parsing (Visible Text)
        else {
            val match = DIRTY_TAIL_REGEX.find(line)
            if (match != null) {
                cleanBody = match.groupValues[1]
                absTime = match.groupValues[2]
                val code = match.groupValues[3]
                flag = when (code) {
                    "u" -> ExerciseFlag.UNILATERAL
                    "s" -> ExerciseFlag.SUPERSET
                    else -> ExerciseFlag.BILATERAL
                }
            }
        }

        body   += cleanBody
        absCol += absTime
        flagCol += flag
    }
    return Triple(body, absCol, flagCol)
}

fun combineTextAndTimes(text: String, times: List<String>, flags: List<ExerciseFlag>): String {
    val lines = if (text.isEmpty()) emptyList() else text.split('\n')
    return lines.mapIndexed { idx, line ->
        var result = line
        val ts = times.getOrNull(idx).orEmpty()
        // append ABS time only once, and only after the invisible SEP
        if (ts.isNotBlank() && !result.endsWith("$SEP$ts")) {
            result += "$SEP$ts"
        }
        val flag = flags.getOrNull(idx) ?: ExerciseFlag.BILATERAL
        val code = when (flag) {
            ExerciseFlag.UNILATERAL -> "u"
            ExerciseFlag.SUPERSET -> "s"
            ExerciseFlag.BILATERAL -> "b"
        }
        result += "$FLAG_SEP$code"
        result
    }.joinToString("\n")
}

class CapitalizeWordsTransformation : VisualTransformation {
    override fun filter(text: AnnotatedString): TransformedText {
        val original = text.text
        val capitalized = original.split(" ").joinToString(" ") { word ->
            word.replaceFirstChar { if (it.isLowerCase()) it.titlecase(Locale.getDefault()) else it.toString() }
        }
        return TransformedText(AnnotatedString(capitalized), OffsetMapping.Identity)
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\core\util\WorkoutParser.kt
=========================================

package com.example.gymtrack.core.util

import java.util.regex.Pattern
import kotlin.math.min

// DTO
data class ParsedSetDTO(
    val exerciseName: String,
    var weight: Float,
    val reps: Int,
    val isUnilateral: Boolean,
    val modifier: String?,
    val brand: String?,
    val relativeTime: String?,
    val absoluteTime: String?,
    val workoutId: Long = 0L
)

class WorkoutParser {

    companion object {

        private val weightRegex = Pattern.compile("(?i)(?:^|\\s)(\\d+(?:\\.\\d+)?)(?:\\s*(kg|lbs))?(?![xX]|[':]|\\d)")
        private val repsRegex = Pattern.compile("(?i)(?:x\\s*([0-9+]+)|([0-9+]+)\\s*x|([0-9+]+)\\s*reps?)")
        private val repsCaptureRegex = Pattern.compile("([0-9+]+)\\s*x", Pattern.CASE_INSENSITIVE)
        private val metadataStartRegex = Regex("""\s*\(?\d+\s*['â€™":]\s*\d+""")
        private val plusNumberRegex = Regex("\\+\\d+")
        private val isolatedNumberRegex = Regex("""\b\d+\b""")
        private val parenNumberRegex = Regex("""\(\s*\d+\s*\)""")

    }


    // --- DICTIONARIES & LISTS ---

    private val BODYWEIGHT_EXERCISES = setOf(
        "pullup", "chinup", "dip", "situp", "pushup", "crunch", "hanging leg raise",
        "leg raise", "air squat", "lunge", "hyperextension", "back extension", "muscle up",
        "burpee", "box jump"
    )

    private val CARDIO_EXERCISES = setOf(
        "cycling", "cycle", "bike", "spinning",
        "stairmaster", "stair master", "stairs",
        "treadmill", "running", "jogging", "run",
        "elliptical", "rowing machine", "ergometer", "rowing"
    )

    private val GYM_TERMS = setOf(
        "press", "push", "pull", "row", "raise", "curl", "extension", "dip",
        "squat", "leg", "arm", "chest", "back", "shoulder", "delt", "bicep", "tricep",
        "dumbbell", "barbell", "kettlebell", "cable", "machine", "smith", "rope",
        "bench", "incline", "decline", "fly", "butterfly", "crunch", "situp",
        "adductor", "abductor", "calf", "glute", "hamstring", "quad",
        "deadlift", "romanian", "stiff", "lunge", "step", "stairmaster", "lat",
        "hack", "seated", "lying", "standing", "assisted", "hanging", "hyperextension"
    ) + BODYWEIGHT_EXERCISES + CARDIO_EXERCISES

    private val BRAND_ALIASES = mapOf(
        "hs" to "Hammer Strength", "hammerstrength" to "Hammer Strength",
        "cy" to "Cybex", "cybex" to "Cybex",
        "syg" to "Sygnum",
        "g80" to "Gym80", "gym80" to "Gym80",
        "lf" to "Life Fitness", "lifefitness" to "Life Fitness",
        "atlantis" to "Atlantis", "prime" to "Prime", "technogym" to "Technogym",
        "matrix" to "Matrix", "precor" to "Precor", "nautilus" to "Nautilus",
        "panatta" to "Panatta", "watson" to "Watson", "rogers" to "Rogers"
    )

    // User's Restricted Modifier List
    private val MODIFIER_ALIASES = mapOf(
        "db" to "Dumbbell", "dbs" to "Dumbbell", "dumbell" to "Dumbbell",
        "bb" to "Barbell", "oh" to "Overgrip",
        "ug" to "Undergrip", "og" to "Overgrip"
    )

    // User's Explicitly Allowed Modifiers
    private val KNOWN_MODIFIERS = setOf(
        "wide", "narrow", "medium", "close", "neutral",
        "undergrip", "overgrip", "ug", "og", "n", "oh",
        "single", "arm", "alternating", "standing",
        "high", "low", "iso", "spt",
        "rope", "cable", "smith", "incline", "decline", "dumbbell", "db", "dbs", "barbell", "bb", "supported"
    )

    private val CORE_MAPPINGS = mapOf(
        "bench" to "bench press",
        "latpull" to "lat pulldown",
        "lat pull" to "lat pulldown",
        "latpulldown" to "lat pulldown",
        "rowing" to "row",
        "pendulum" to "pendulum squat",
        "side" to "lateral",
        "rear" to "posterior",
        "medial" to "lateral",
        "pull up" to "pullup", "pullup" to "pullup",
        "stair master" to "stairmaster",
        "hacksquat" to "hack squat",
        "legraise" to "leg raise",
        "ad abductor" to "adductor",
        "buttferfli" to "butterfly",
        "cycle" to "cycling", "bike" to "cycling"
    )

    private val NOISE_WORDS = setOf("uni", "ss", "u", "b", "l", "r", "with", "on", "no", "v")
    private val VOCABULARY = GYM_TERMS + BRAND_ALIASES.keys + BRAND_ALIASES.values + MODIFIER_ALIASES.keys + MODIFIER_ALIASES.values + KNOWN_MODIFIERS

    // --- NEW HELPER: Calculate Reps from String (handles "5+5") ---
    private fun calculateReps(raw: String?): Int {
        if (raw == null) return 0
        // Split by '+' and sum (e.g. "5+5" -> 10)
        return raw.split("+").sumOf { it.trim().toIntOrNull() ?: 0 }
    }

    // --- ALGORITHMS ---

    private fun levenshtein(lhs: CharSequence, rhs: CharSequence): Int {
        val lhsLen = lhs.length
        val rhsLen = rhs.length
        var costs = IntArray(rhsLen + 1) { it }
        var newCosts = IntArray(rhsLen + 1)
        for (i in 0 until lhsLen) {
            newCosts[0] = i + 1
            for (j in 0 until rhsLen) {
                val cost = if (lhs[i] == rhs[j]) 0 else 1
                newCosts[j + 1] = min(newCosts[j] + 1, min(costs[j + 1] + 1, costs[j] + cost))
            }
            val temp = costs
            costs = newCosts
            newCosts = temp
        }
        return costs[rhsLen]
    }

    private fun autocorrect(word: String): String {
        if (VOCABULARY.contains(word)) return word
        if (word.length < 3) return word
        var bestMatch = word
        var lowestDistance = Int.MAX_VALUE
        for (term in VOCABULARY) {
            val distance = levenshtein(word, term)
            val threshold = if (term.length > 5) 2 else 1
            if (distance <= threshold && distance < lowestDistance) {
                lowestDistance = distance
                bestMatch = term
            }
        }
        return bestMatch
    }

    private fun singularize(text: String): String {
        val words = text.split(" ")
        return words.joinToString(" ") { word ->
            when {
                word.endsWith("ies") -> word.dropLast(3) + "y"
                word.endsWith("ss") -> word
                word.endsWith("s") -> word.dropLast(1)
                else -> word
            }
        }
    }

    // --- PIPELINE LOGIC ---

    private fun extractDetails(rawLine: String, rawMetadata: String): Triple<String, String?, String?> {
        // Step 0: Pre-cleaning
        var cleanedLine = rawLine.lowercase()
            .replace(parenNumberRegex, "")
            .replace(isolatedNumberRegex, "")
            .replace(plusNumberRegex, "")
            .trim()

        // Step 1: Tokenize & Autocorrect
        var tokens = cleanedLine.split("\\s+".toRegex()).toMutableList()
        val correctedTokens = tokens.map { autocorrect(it) }.toMutableList()
        tokens = correctedTokens

        // Step 2: Extract Brands
        val foundBrands = mutableSetOf<String>()
        val remainingTokensStep2 = mutableListOf<String>()
        for (token in tokens) {
            if (BRAND_ALIASES.containsKey(token)) {
                foundBrands.add(BRAND_ALIASES[token]!!)
            } else if (BRAND_ALIASES.values.any { it.equals(token, true) }) {
                foundBrands.add(BRAND_ALIASES.entries.first { it.value.equals(token, true) }.value)
            } else {
                remainingTokensStep2.add(token)
            }
        }
        tokens = remainingTokensStep2

        // Step 3: Extract Modifiers
        val foundModifiers = mutableSetOf<String>()
        val remainingTokensStep3 = mutableListOf<String>()
        for (token in tokens) {
            if (MODIFIER_ALIASES.containsKey(token)) {
                foundModifiers.add(MODIFIER_ALIASES[token]!!)
            } else if (KNOWN_MODIFIERS.contains(token)) {
                val standardized = token.replaceFirstChar { it.titlecase() }
                foundModifiers.add(standardized)
            } else {
                remainingTokensStep3.add(token)
            }
        }
        tokens = remainingTokensStep3

        // Step 4: Core Name Normalization
        var coreName = tokens.joinToString(" ")
            .replace(Regex("[-/.,]"), " ")
            .replace(Regex("\\s+"), " ")
            .trim()

        coreName = singularize(coreName)

        if (CORE_MAPPINGS.containsKey(coreName)) {
            coreName = CORE_MAPPINGS[coreName]!!
        }

        val finalTokens = coreName.split(" ").filter { !NOISE_WORDS.contains(it) }
        coreName = finalTokens.joinToString(" ").replaceFirstChar { it.titlecase() }

        val brandStr = if (foundBrands.isNotEmpty()) foundBrands.joinToString(", ") else null
        val modStr = if (foundModifiers.isNotEmpty()) foundModifiers.joinToString(", ") else null

        return Triple(coreName, modStr, brandStr)
    }

    private fun extractTimes(rawMetadata: String): Pair<String?, String?> {
        if (rawMetadata.isBlank()) return Pair(null, null)
        val relMatch = Regex("""\(\s*(\d+['â€™":]\d+)\s*["â€]?\s*\)""").find(rawMetadata)
        val relativeTime = relMatch?.groupValues?.get(1)
        var remaining = rawMetadata
        if (relMatch != null) remaining = remaining.replace(relMatch.value, "")
        val absMatch = Regex("""(\d+['â€™":]\d+)""").find(remaining)
        val absoluteTime = absMatch?.groupValues?.get(1)
        return Pair(relativeTime, absoluteTime)
    }

    fun parseWorkout(rawText: String): List<ParsedSetDTO> {
        val results = mutableListOf<ParsedSetDTO>()

        var currentExerciseName = "Unknown"
        var currentModifier: String? = null
        var currentBrand: String? = null
        var currentRelTime: String? = null
        var currentAbsTime: String? = null
        var currentWeight = 0f

        val lines = rawText.split("\n")

        for (line in lines) {
            if (line.isBlank()) continue

            val matchResult = metadataStartRegex.find(line)
            val rawNamePart = if (matchResult != null) line.substring(0, matchResult.range.first) else line
            val rawMetadataPart = if (matchResult != null) line.substring(matchResult.range.first) else ""

            val cleanLine = rawNamePart.trim()

            // Set Detection Logic
            val looksLikeSet = cleanLine.matches(Regex("(?i)^[\\d+]+\\s*x.*")) ||
                    cleanLine.matches(Regex("(?i)^x\\s*[\\d+]+.*")) ||
                    repsRegex.matcher(cleanLine).find() ||
                    cleanLine.matches(Regex("^\\d+$")) ||
                    line.startsWith("    ")

            if (!looksLikeSet) {
                // --- HEADER LINE ---
                currentWeight = 0f

                val (rel, abs) = extractTimes(rawMetadataPart)
                currentRelTime = rel
                currentAbsTime = abs

                val (name, mod, brand) = extractDetails(cleanLine, rawMetadataPart)
                currentExerciseName = name
                currentModifier = mod
                currentBrand = brand

            } else {
                // --- SET LINE ---
                val isCardio = CARDIO_EXERCISES.contains(currentExerciseName.lowercase())
                val isBodyweight = BODYWEIGHT_EXERCISES.contains(currentExerciseName.lowercase())

                var weight = 0f
                var reps = 0

                val lineContent = cleanLine // Start with the full text
                var remainder = cleanLine // Will hold the weight part

                // --- Step A: Extract Reps (Primary Action) ---
                val repsMatcher = repsCaptureRegex.matcher(lineContent)

                if (repsMatcher.find()) {
                    // 1. Get the raw rep string (e.g., "50+50")
                    val rawRepString = repsMatcher.group(1)

                    // 2. Calculate the sum (e.g., 100)
                    reps = calculateReps(rawRepString)

                    // 3. FIX: Use the standard String.replaceFirst to remove the matched text.
                    // The matched text includes the final 'x' (e.g., "50+50x").
                    // We get the exact text matched by the entire expression using match.group(0).
                    val matchedRepExpression = repsMatcher.group(0)
                    remainder = lineContent.replaceFirst(matchedRepExpression, "").trim()
                }

                // --- Step B: Extract Weight from Remainder ---
                if (reps > 0) {
                    val weightMatcher = weightRegex.matcher(remainder)
                    if (weightMatcher.find()) {
                        val found = weightMatcher.group(1)?.toFloatOrNull()
                        if (found != null) weight = found
                    }
                }

                // --- Cardio Logic ---
                if (isCardio) {
                    if (reps == 0 && weight > 0) {
                        reps = weight.toInt() // Weight is duration
                        weight = 0f
                    }
                }

                // --- Carry-Over Logic ---
                if (weight > 0f) currentWeight = weight

                val finalWeight = if (isBodyweight && weight == 0f) 0f else currentWeight

                val isValidSet = if (isBodyweight || isCardio) {
                    reps > 0
                } else {
                    reps > 0 && finalWeight > 0f
                }

                if (isValidSet) {
                    results.add(
                        ParsedSetDTO(
                            exerciseName = currentExerciseName,
                            weight = finalWeight,
                            reps = reps,
                            isUnilateral = line.contains("\u200Cu") || line.lowercase().contains("uni"),
                            modifier = currentModifier,
                            brand = currentBrand,
                            relativeTime = currentRelTime,
                            absoluteTime = currentAbsTime
                        )
                    )
                }
            }
        }
        return results
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\editor\components\EditorHeroHeader.kt
=========================================

package com.example.gymtrack.feature.editor.components

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowDropDown
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.Dp
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.gymtrack.core.data.Category
import com.example.gymtrack.core.data.Settings
import java.text.SimpleDateFormat
import java.util.Date
import java.util.Locale

@Composable
fun EditorHeroHeader(
    timestamp: Long,
    settings: Settings,
    selectedCategory: Category?,
    onCategorySelect: (Category) -> Unit,
    topPadding: Dp
) {
    // [FIX] Use the actual color from the selected category object
    val baseColor = if (selectedCategory != null) Color(selectedCategory.color) else Color(0xFF666666)

    val backgroundColor = MaterialTheme.colorScheme.background
    // Create gradient fading to background
    val blendGradient = remember(baseColor, backgroundColor) {
        Brush.verticalGradient(listOf(baseColor.copy(alpha = 0.25f), backgroundColor))
    }

    var menuExpanded by remember { mutableStateOf(false) }
    val date = Date(timestamp)
    val weekdayFormat = remember { SimpleDateFormat("EEEE", Locale.getDefault()) }
    val dateFormat = remember { SimpleDateFormat("dd/MM/yyyy", Locale.getDefault()) }
    val timeFormat = remember { SimpleDateFormat(if (settings.is24Hour) "HH:mm" else "hh:mm a", Locale.getDefault()) }
    val textColor = MaterialTheme.colorScheme.onSurface

    Box(
        modifier = Modifier
            .fillMaxWidth()
            .background(backgroundColor)
            .background(blendGradient)
            .padding(top = topPadding, start = 16.dp, end = 16.dp, bottom = 16.dp)
    ) {
        Column {
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.Bottom
            ) {
                Column {
                    Text(weekdayFormat.format(date), style = MaterialTheme.typography.headlineMedium, fontWeight = FontWeight.ExtraBold, color = textColor)
                    Text(timeFormat.format(date), style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.Bold, color = textColor)
                }
                Column(horizontalAlignment = Alignment.End) {
                    Text(dateFormat.format(date), style = MaterialTheme.typography.titleMedium, color = textColor.copy(alpha = 0.8f))
                    Spacer(Modifier.height(4.dp))
                }
            }
            Spacer(Modifier.height(12.dp))

            // Category Selector
            Box {
                Surface(
                    color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.1f),
                    shape = RoundedCornerShape(8.dp),
                    modifier = Modifier.clickable { menuExpanded = true }
                ) {
                    Row(
                        verticalAlignment = Alignment.CenterVertically,
                        modifier = Modifier.padding(horizontal = 12.dp, vertical = 6.dp)
                    ) {
                        Box(Modifier.size(8.dp).clip(RoundedCornerShape(50)).background(baseColor))
                        Spacer(Modifier.width(8.dp))
                        Text(selectedCategory?.name ?: "Select Category", color = MaterialTheme.colorScheme.onSurface, fontWeight = FontWeight.SemiBold, fontSize = 14.sp)
                        Spacer(Modifier.width(4.dp))
                        Icon(Icons.Default.ArrowDropDown, contentDescription = null, tint = MaterialTheme.colorScheme.onSurface)
                    }
                }
                DropdownMenu(
                    expanded = menuExpanded,
                    onDismissRequest = { menuExpanded = false },
                    modifier = Modifier.background(MaterialTheme.colorScheme.surface)
                ) {
                    settings.categories.forEach { cat ->
                        DropdownMenuItem(
                            text = { Text(cat.name, color = MaterialTheme.colorScheme.onSurface) },
                            leadingIcon = { Box(Modifier.size(12.dp).clip(RoundedCornerShape(50)).background(Color(cat.color))) },
                            onClick = { onCategorySelect(cat); menuExpanded = false }
                        )
                    }
                }
            }
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\editor\components\EditorListSection.kt
=========================================

package com.example.gymtrack.feature.editor.components

import androidx.compose.foundation.ExperimentalFoundationApi
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.PaddingValues
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.imePadding
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.itemsIndexed
import androidx.compose.foundation.relocation.BringIntoViewRequester
import androidx.compose.foundation.relocation.bringIntoViewRequester
import androidx.compose.foundation.text.BasicTextField
import androidx.compose.material3.LocalTextStyle
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.remember
import androidx.compose.runtime.rememberCoroutineScope
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.focus.focusRequester
import androidx.compose.ui.focus.onFocusChanged
import androidx.compose.ui.graphics.SolidColor
import androidx.compose.ui.text.AnnotatedString
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.gymtrack.core.data.ExerciseFlag
import com.example.gymtrack.feature.editor.NoteEditorState
import com.example.gymtrack.core.util.CapitalizeWordsTransformation
import com.example.gymtrack.core.util.SmallSecondsVisualTransformation
import com.example.gymtrack.core.util.rememberRelativeTimeVisualTransformation
import kotlinx.coroutines.launch


// --- COMPONENT: EDITOR LIST SECTION (UPDATED) ---
@OptIn(ExperimentalFoundationApi::class)
@Composable
fun EditorListSection(state: NoteEditorState, modifier: Modifier = Modifier) {
    val coroutineScope = rememberCoroutineScope()
    val capitalizeTransformation = remember { CapitalizeWordsTransformation() }

    LazyColumn(
        state = state.listState,
        modifier = modifier
            .fillMaxSize()
            .imePadding(),
        contentPadding = PaddingValues(bottom = 150.dp)
    ) {
        itemsIndexed(state.lines, key = { _, row -> row.id }) { index, row ->
            val fr = row.focusRequester
            val bringIntoViewRequester = remember { BringIntoViewRequester() }
            val isMain = index == 0 || state.lines.getOrNull(index - 1)?.text?.value?.text?.isBlank() != false

            val fontSize = if (isMain) 22.sp else 14.sp
            val fontWeight = if (isMain) FontWeight.Black else FontWeight.Medium
            val textColor = if (isMain) MaterialTheme.colorScheme.onSurface else MaterialTheme.colorScheme.onSurfaceVariant

            val visualTransformation = if (isMain) {
                capitalizeTransformation
            } else {
                rememberRelativeTimeVisualTransformation(fontSize)
            }

            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(vertical = 0.dp)
                    .bringIntoViewRequester(bringIntoViewRequester),
                verticalAlignment = Alignment.CenterVertically
            ) {
                // Flag / Tag Column
                Box(
                    modifier = Modifier.width(50.dp),
                    contentAlignment = Alignment.CenterStart
                ) {
                    if (row.text.value.text.isNotBlank()) {
                        if (isMain) {
                            ExerciseFlagButton(
                                flag = row.flag.value,
                                relColor = textColor,
                                onToggle = { state.toggleFlag(index) }
                            )
                        } else {
                            var p = index - 1
                            while (p >= 0 && (state.lines.getOrNull(p - 1)?.text?.value?.text?.isNotBlank() == true)) p--
                            val parentFlag = state.lines.getOrNull(p)?.flag?.value ?: ExerciseFlag.BILATERAL
                            ExerciseFlagTag(flag = parentFlag, relColor = textColor)
                        }
                    }
                }

                Spacer(Modifier.width(8.dp))

                // Input Field
                Row(
                    modifier = Modifier.weight(1f),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    BasicTextField(
                        value = row.text.value,
                        onValueChange = { state.onTextChange(index, it) },
                        textStyle = LocalTextStyle.current.copy(
                            color = textColor,
                            fontSize = fontSize,
                            fontWeight = fontWeight,
                        ),
                        cursorBrush = SolidColor(MaterialTheme.colorScheme.primary),
                        visualTransformation = visualTransformation,
                        modifier = Modifier
                            .fillMaxWidth()
                            .focusRequester(fr)
                            .onFocusChanged {
                                if (it.isFocused) {
                                    coroutineScope.launch {
                                        bringIntoViewRequester.bringIntoView()
                                    }
                                }
                            }
                    )
                }

                // Timestamp
                val absText = state.timestamps.getOrElse(index) { "" }
                if (absText.isNotBlank()) {
                    val absAnnotated = SmallSecondsVisualTransformation(14.sp).filter(AnnotatedString(absText)).text
                    Text(
                        text = absAnnotated,
                        fontSize = 14.sp,
                        color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.4f),
                        modifier = Modifier.padding(start = 8.dp)
                    )
                }
            }
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\editor\components\ExerciseFlagButton.kt
=========================================

package com.example.gymtrack.feature.editor.components

import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.layout.PaddingValues
import androidx.compose.foundation.layout.defaultMinSize
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.gymtrack.core.data.ExerciseFlag
import com.example.gymtrack.core.ui.theme.SupersetBlue

@Composable
fun ExerciseFlagButton(
    flag: ExerciseFlag,
    relColor: Color,
    onToggle: () -> Unit,
    modifier: Modifier = Modifier
) {
    val activeColor = when (flag) {
        ExerciseFlag.UNILATERAL -> MaterialTheme.colorScheme.error
        ExerciseFlag.SUPERSET -> SupersetBlue
        ExerciseFlag.BILATERAL -> MaterialTheme.colorScheme.onSurface // Brighter default
    }

    val containerColor = if (flag == ExerciseFlag.BILATERAL) {
        Color.Transparent
    } else {
        activeColor.copy(alpha = 0.15f) // Slightly stronger tint
    }

    Button(
        onClick = onToggle,
        colors = ButtonDefaults.buttonColors(
            containerColor = containerColor,
            contentColor = activeColor
        ),
        // Thicker border for better visibility
        border = if (flag == ExerciseFlag.BILATERAL) BorderStroke(1.5.dp, activeColor.copy(alpha = 0.5f)) else null,
        shape = RoundedCornerShape(8.dp), // Slightly rounder
        contentPadding = PaddingValues(0.dp),
        // [CHANGE] Increased size significantly (was 32x24)
        modifier = modifier.defaultMinSize(minWidth = 44.dp, minHeight = 30.dp)
    ) {
        val text = when (flag) {
            ExerciseFlag.BILATERAL -> "Bi"
            ExerciseFlag.UNILATERAL -> "Uni"
            ExerciseFlag.SUPERSET -> "SS"
        }
        Text(
            text = text,
            textAlign = TextAlign.Center,
            fontWeight = FontWeight.Black, // Boldest weight
            fontSize = 16.sp // Larger text
        )
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\editor\components\ExerciseFlagTag.kt
=========================================

package com.example.gymtrack.feature.editor.components

import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.layout.PaddingValues
import androidx.compose.foundation.layout.defaultMinSize
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.OutlinedButton
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.gymtrack.core.data.ExerciseFlag
import com.example.gymtrack.core.ui.theme.SupersetBlue

@Composable
fun ExerciseFlagTag(
    flag: ExerciseFlag,
    relColor: Color,
    modifier: Modifier = Modifier
) {
    val color = when (flag) {
        ExerciseFlag.UNILATERAL -> MaterialTheme.colorScheme.error
        ExerciseFlag.SUPERSET -> SupersetBlue
        ExerciseFlag.BILATERAL -> relColor.copy(alpha = 0.5f)
    }

    OutlinedButton(
        onClick = {},
        enabled = false,
        border = BorderStroke(1.dp, color.copy(alpha = 0.3f)),
        colors = ButtonDefaults.outlinedButtonColors(
            containerColor = Color.Transparent,
            disabledContentColor = color,
        ),
        shape = RoundedCornerShape(6.dp),
        contentPadding = PaddingValues(0.dp),
        modifier = modifier.defaultMinSize(minWidth = 28.dp, minHeight = 15.dp)
    ) {
        val text = when (flag) {
            ExerciseFlag.BILATERAL -> "1x"
            ExerciseFlag.UNILATERAL -> "2x"
            ExerciseFlag.SUPERSET -> "2x"
        }
        Text(
            text,
            textAlign = TextAlign.Center,
            fontWeight = FontWeight.Bold,
            fontSize = 12.sp
        )
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\editor\components\LearningsPopup.kt
=========================================

package com.example.gymtrack.feature.editor.components

import android.annotation.SuppressLint
import androidx.compose.animation.AnimatedVisibility
import androidx.compose.animation.fadeIn
import androidx.compose.animation.fadeOut
import androidx.compose.animation.scaleIn
import androidx.compose.animation.scaleOut
import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.BoxWithConstraints
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.imePadding
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.material3.LocalTextStyle
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.OutlinedTextField
import androidx.compose.material3.OutlinedTextFieldDefaults
import androidx.compose.material3.Surface
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.remember
import androidx.compose.runtime.withFrameNanos
import androidx.compose.ui.focus.FocusRequester
import androidx.compose.ui.focus.focusRequester
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.TextRange
import androidx.compose.ui.text.input.TextFieldValue
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.gymtrack.core.util.rememberBulletListTransformation

@SuppressLint("UnusedBoxWithConstraintsScope")
@Composable
fun LearningsPopup(
    showLearnings: Boolean,
    learningsValue: TextFieldValue,
    onDismiss: () -> Unit,
    onValueChange: (TextFieldValue) -> Unit,
) {
    val focusRequester = remember { FocusRequester() }

    LaunchedEffect(showLearnings) {
        if (showLearnings) {
            var text = learningsValue.text
            if (text.isNotEmpty() && !text.endsWith("\n")) {
                text += "\n"
            }
            val selection = TextRange(text.length)
            onValueChange(TextFieldValue(text, selection))
            withFrameNanos { }
            focusRequester.requestFocus()
        }
    }

    AnimatedVisibility(
        visible = showLearnings,
        enter = scaleIn() + fadeIn(),
        exit = scaleOut() + fadeOut()
    ) {
        Box(
            modifier = Modifier
                .padding(horizontal = 10.dp)
                .fillMaxSize()
                .clickable { onDismiss() },
                    contentAlignment = Alignment.TopCenter
        ) {
            BoxWithConstraints {
                val offset = maxHeight / 3
                Surface(
                    color = MaterialTheme.colorScheme.surface,
                    tonalElevation = 0.dp,
                    shape = MaterialTheme.shapes.medium,
                    border = BorderStroke(2.dp, Color.LightGray.copy(alpha = 0.2F)),
                    modifier = Modifier
                        .padding(
                            top = offset,
                            start = 16.dp,
                            end = 16.dp,
                            bottom = 16.dp
                        )
                        .imePadding()
                ) {
                    Column(
                        modifier = Modifier
                            .padding(16.dp)
                            .fillMaxWidth()
                    ) {
                        Text(
                            "Notes",
                            fontWeight = FontWeight.Bold,
                            color = MaterialTheme.colorScheme.onSurface,
                            modifier = Modifier.align(Alignment.CenterHorizontally)
                        )
                        Spacer(Modifier.height(8.dp))
                        Column(
                            modifier = Modifier
                                .weight(1f)
                                .verticalScroll(rememberScrollState())
                        ) {
                            OutlinedTextField(
                                value = learningsValue,
                                onValueChange = { onValueChange(it) },
                                placeholder = { Text("Learnings") },
                                modifier = Modifier
                                    .fillMaxWidth()
                                    .focusRequester(focusRequester),
                                textStyle = LocalTextStyle.current.copy(lineHeight = 22.sp),
                                visualTransformation = rememberBulletListTransformation(),
                                colors = OutlinedTextFieldDefaults.colors(
                                    focusedBorderColor = Color.Transparent,
                                    unfocusedBorderColor = Color.Transparent,
                                    focusedContainerColor = MaterialTheme.colorScheme.surface,
                                    unfocusedContainerColor = MaterialTheme.colorScheme.surface,
                                    focusedTextColor = MaterialTheme.colorScheme.onSurface,
                                    unfocusedTextColor = MaterialTheme.colorScheme.onSurface,
                                    cursorColor = MaterialTheme.colorScheme.onSurface,
                                )
                            )
                        }
                        Spacer(Modifier.height(8.dp))
                    }
                }
            }
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\editor\components\NoteEditorHeader.kt
=========================================

package com.example.gymtrack.feature.editor.components

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.BasicTextField
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material.icons.filled.Check
import androidx.compose.material.icons.filled.Star
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.SolidColor
import androidx.compose.ui.text.TextStyle
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.gymtrack.core.data.Category

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun NoteEditorHeader(
    title: String,
    onTitleChange: (String) -> Unit,
    category: Category,
    onCategoryChange: (Category) -> Unit,
    onSave: () -> Unit,
    onBack: () -> Unit,
    onLearningsClick: () -> Unit
) {
    // Default categories list for the dropdown
    val categories = listOf(
        Category("Push", 0xFFE57373),
        Category("Pull", 0xFF64B5F6),
        Category("Legs", 0xFF81C784),
        Category("Other", 0xFFFFB74D),
        Category("Cardio", 0xFFBA68C8)
    )

    var categoryMenuExpanded by remember { mutableStateOf(false) }

    Surface(
        shadowElevation = 4.dp,
        color = MaterialTheme.colorScheme.surface
    ) {
        Column(modifier = Modifier.fillMaxWidth()) {
            // Top Row: Back, Category, Save
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(horizontal = 8.dp, vertical = 8.dp),
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.SpaceBetween
            ) {
                IconButton(onClick = onBack) {
                    Icon(Icons.Default.ArrowBack, contentDescription = "Back")
                }

                // Category Chip / Dropdown
                Box {
                    Row(
                        verticalAlignment = Alignment.CenterVertically,
                        modifier = Modifier
                            .clip(RoundedCornerShape(16.dp))
                            .background(MaterialTheme.colorScheme.surfaceVariant)
                            .clickable { categoryMenuExpanded = true }
                            .padding(horizontal = 12.dp, vertical = 6.dp)
                    ) {
                        Box(
                            modifier = Modifier
                                .size(12.dp)
                                .clip(CircleShape)
                                .background(Color(category.color))
                        )
                        Spacer(modifier = Modifier.width(8.dp))
                        Text(
                            text = category.name,
                            style = MaterialTheme.typography.labelLarge,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }

                    DropdownMenu(
                        expanded = categoryMenuExpanded,
                        onDismissRequest = { categoryMenuExpanded = false }
                    ) {
                        categories.forEach { cat ->
                            DropdownMenuItem(
                                text = { Text(cat.name) },
                                leadingIcon = {
                                    Box(
                                        modifier = Modifier
                                            .size(12.dp)
                                            .clip(CircleShape)
                                            .background(Color(cat.color))
                                    )
                                },
                                onClick = {
                                    onCategoryChange(cat)
                                    categoryMenuExpanded = false
                                }
                            )
                        }
                    }
                }

                // Right Actions: Learnings & Save
                Row {
                    IconButton(onClick = onLearningsClick) {
                        Icon(
                            Icons.Default.Star,
                            contentDescription = "Learnings",
                            tint = MaterialTheme.colorScheme.primary
                        )
                    }
                    IconButton(onClick = onSave) {
                        Icon(
                            Icons.Default.Check,
                            contentDescription = "Save",
                            tint = MaterialTheme.colorScheme.primary
                        )
                    }
                }
            }

            // Title Input Row
            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(start = 56.dp, end = 16.dp, bottom = 12.dp)
            ) {
                if (title.isEmpty()) {
                    Text(
                        text = "Workout Title",
                        style = MaterialTheme.typography.headlineSmall,
                        color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.5f)
                    )
                }
                BasicTextField(
                    value = title,
                    onValueChange = onTitleChange,
                    textStyle = TextStyle(
                        fontSize = 24.sp,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onSurface
                    ),
                    cursorBrush = SolidColor(MaterialTheme.colorScheme.primary),
                    modifier = Modifier.fillMaxWidth()
                )
            }
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\editor\components\NoteEditorRow.kt
=========================================

package com.example.gymtrack.feature.editor.components

import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.text.KeyboardActions
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.material3.HorizontalDivider
import androidx.compose.material3.TextField
import androidx.compose.material3.TextFieldDefaults
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.focus.FocusRequester
import androidx.compose.ui.focus.focusRequester
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.input.ImeAction
import androidx.compose.ui.text.input.TextFieldValue
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.gymtrack.core.util.rememberRelativeTimeVisualTransformation

@Composable
fun NoteEditorRow(
    textValue: TextFieldValue,
    onValueChange: (TextFieldValue) -> Unit,
    focusRequester: FocusRequester,
    onNextAction: () -> Unit,
    modifier: Modifier = Modifier
) {
    TextField(
        value = textValue,
        onValueChange = onValueChange,
        modifier = modifier
            .fillMaxWidth()
            .focusRequester(focusRequester),
        colors = TextFieldDefaults.colors(
            focusedContainerColor = Color.Transparent,
            unfocusedContainerColor = Color.Transparent,
            focusedIndicatorColor = Color.Transparent,
            unfocusedIndicatorColor = Color.Transparent
        ),
        // IME Action 'Next' triggers the new line logic
        keyboardOptions = KeyboardOptions(imeAction = ImeAction.Next),
        keyboardActions = KeyboardActions(
            onNext = { onNextAction() }
        ),
        // Apply the visual transformation for (m'ss'')
        visualTransformation = rememberRelativeTimeVisualTransformation(16.sp)
    )

    HorizontalDivider(thickness = 0.5.dp, color = Color.Gray.copy(alpha = 0.3f))
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\editor\components\NoteEditorTopBar.kt
=========================================

package com.example.gymtrack.feature.editor.components

import androidx.compose.foundation.Image
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Menu
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.gymtrack.R

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun NoteEditorTopBar(onEdit: () -> Unit) {
    CenterAlignedTopAppBar(
        colors = TopAppBarDefaults.centerAlignedTopAppBarColors(
            containerColor = MaterialTheme.colorScheme.surface
        ),
        navigationIcon = {
            Image(
                painter = painterResource(id = R.drawable.ic_gymtrack_logo),
                contentDescription = "GymTrack logo",
                modifier = Modifier.size(45.dp)
            )
        },
        title = { Text("GymTrack", fontSize = 24.sp) },
        actions = {
            IconButton(onClick = onEdit, modifier = Modifier.padding(end = 10.dp)) {
                Icon(
                    Icons.Default.Menu,
                    contentDescription = "Edit",
                    tint = MaterialTheme.colorScheme.onSurface
                )
            }
        }
    )
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\editor\components\NoteTimer.kt
=========================================

package com.example.gymtrack.feature.editor.components

import android.Manifest
import android.content.Context
import android.content.Intent
import android.content.pm.PackageManager
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.padding
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Pause
import androidx.compose.material.icons.filled.PlayArrow
import androidx.compose.material.icons.filled.Stop
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.unit.dp
import androidx.core.content.ContextCompat
import com.example.gymtrack.core.services.NoteTimerService
import com.example.gymtrack.core.util.formatSecondsToMinutesSeconds

@Composable
fun NoteTimer(noteTimestamp: Long, modifier: Modifier = Modifier) {
    val context = LocalContext.current

    val permissionLauncher = rememberLauncherForActivityResult(
        ActivityResultContracts.RequestPermission()
    ) { granted ->
        if (granted) {
            startTimerService(context, noteTimestamp)
        }
    }

    LaunchedEffect(noteTimestamp) {
        val hasPermission = ContextCompat.checkSelfPermission(
            context,
            Manifest.permission.POST_NOTIFICATIONS
        ) == PackageManager.PERMISSION_GRANTED

        if (hasPermission) {
            startTimerService(context, noteTimestamp)
        } else {
            permissionLauncher.launch(Manifest.permission.POST_NOTIFICATIONS)
        }
    }

    val elapsed by NoteTimerService.elapsedSeconds.collectAsState()
    val running by NoteTimerService.isRunning.collectAsState()

    Row(
        modifier = modifier.padding(horizontal = 4.dp),
        horizontalArrangement = Arrangement.spacedBy(8.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        Text(
            formatSecondsToMinutesSeconds(elapsed),
            style = MaterialTheme.typography.titleLarge
        )
        IconButton(onClick = {
            val actionId = if (running) NoteTimerService.ACTION_PAUSE else NoteTimerService.ACTION_RESUME
            ContextCompat.startForegroundService(
                context,
                Intent(context, NoteTimerService::class.java).apply {
                    action = actionId // [FIX] Correct syntax
                }
            )
        }) {
            Icon(
                imageVector = if (running) Icons.Filled.Pause else Icons.Filled.PlayArrow,
                contentDescription = if (running) "Pause" else "Resume"
            )
        }
        IconButton(onClick = {
            ContextCompat.startForegroundService(
                context,
                Intent(context, NoteTimerService::class.java).apply {
                    action = NoteTimerService.ACTION_STOP // [FIX] Correct syntax
                }
            )
        }) {
            Icon(imageVector = Icons.Filled.Stop, contentDescription = "Stop")
        }
    }
}

private fun startTimerService(context: Context, noteTimestamp: Long) {
    ContextCompat.startForegroundService(
        context,
        Intent(context, NoteTimerService::class.java).apply {
            action = NoteTimerService.ACTION_START // [FIX] Correct syntax
            putExtra(NoteTimerService.EXTRA_NOTE, noteTimestamp)
        }
    )
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\editor\EditorViewModel.kt
=========================================

package com.example.gymtrack.feature.editor

import androidx.lifecycle.ViewModel
import androidx.lifecycle.ViewModelProvider
import androidx.lifecycle.viewModelScope
import com.example.gymtrack.core.data.Category
import com.example.gymtrack.core.data.NoteEntity
import com.example.gymtrack.core.data.NoteLine
import com.example.gymtrack.core.data.Settings
import com.example.gymtrack.core.data.repository.NoteRepository
import com.example.gymtrack.core.data.WorkoutRepository
import com.example.gymtrack.core.util.exportNote
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import android.content.Context
import kotlinx.coroutines.NonCancellable

class EditorViewModel(
    private val initialId: Long,
    private val noteRepo: NoteRepository,
    private val workoutRepo: WorkoutRepository,
    private val context: Context
) : ViewModel() {

    private val _uiState = MutableStateFlow<NoteLine?>(null)
    val uiState = _uiState.asStateFlow()

    var currentId: Long = initialId // This can now change from -1 to a real timestamp

    var currentTitle = ""
    var currentCategory: Category? = null
    var currentLearnings = ""

    init {
        if (initialId != -1L) {
            viewModelScope.launch {
                val note = noteRepo.getNoteById(initialId)
                initialize(note)
            }
        } else {
            initialize(null) // New note
        }
    }


    // Initialize the editor with data (Called once when UI loads)
    fun initialize(note: NoteLine?) {
        if (note != null) {
            currentTitle = note.title
            currentCategory = Category(note.categoryName ?: "Uncategorized", note.categoryColor ?: 0xFF808080)
            currentLearnings = note.learnings
            _uiState.value = note
        } else {
            // Defaults for new note
            currentCategory = Category("Push", 0xFFFF3B30) // Default
        }
    }

    fun saveNote(finalText: String, settings: Settings, onComplete: () -> Unit) {
        viewModelScope.launch(Dispatchers.IO) {
            withContext(NonCancellable) {
                val timestamp = if (currentId != -1L) currentId else System.currentTimeMillis()
                currentId = timestamp

                val updatedNote = NoteLine(
                    title = currentTitle,
                    text = finalText,
                    timestamp = timestamp,
                    categoryName = currentCategory?.name,
                    categoryColor = currentCategory?.color,
                    learnings = currentLearnings
                )

                noteRepo.saveNote(updatedNote)

                // CRITICAL: Update the internal state so the ViewModel knows it's saved
                _uiState.value = updatedNote

                val entity = NoteEntity(timestamp, updatedNote.title, updatedNote.text,
                    updatedNote.categoryName, updatedNote.categoryColor, updatedNote.learnings)
                workoutRepo.syncNoteToWorkout(entity)
                exportNote(context, updatedNote, settings)
            }
            withContext(Dispatchers.Main) {
                onComplete()
            }
        }
    }

    // Factory
    class Factory(
        private val noteId: Long,
        private val noteRepo: NoteRepository,
        private val workoutRepo: WorkoutRepository,
        private val context: Context
    ) : ViewModelProvider.Factory {
        @Suppress("UNCHECKED_CAST")
        override fun <T : ViewModel> create(modelClass: Class<T>): T {
            return EditorViewModel(noteId, noteRepo, workoutRepo, context) as T
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\editor\NoteEditor.kt
=========================================

package com.example.gymtrack.feature.editor // Adjust to your package

import android.annotation.SuppressLint
import android.app.Activity
import androidx.activity.compose.BackHandler
import androidx.compose.foundation.layout.*
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material.icons.filled.Menu
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalLifecycleOwner
import androidx.compose.ui.platform.LocalView
import androidx.compose.ui.text.input.TextFieldValue
import androidx.compose.ui.unit.dp
import androidx.core.view.WindowInsetsControllerCompat
import androidx.lifecycle.Lifecycle
import androidx.lifecycle.LifecycleEventObserver
import com.example.gymtrack.core.data.Category
import com.example.gymtrack.core.data.Settings
import com.example.gymtrack.feature.editor.components.EditorHeroHeader
import com.example.gymtrack.feature.editor.components.EditorListSection
import com.example.gymtrack.feature.editor.components.LearningsPopup

@SuppressLint("UnusedBoxWithConstraintsScope")
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun NoteEditor(
    viewModel: EditorViewModel,
    settings: Settings,
    isLastNote: Boolean,
    onCancel: () -> Unit, // This is actually "On Back"
    onSaveSuccess: () -> Unit
) {
    // 1. Load Data
    val note by viewModel.uiState.collectAsState()
    val isEditingExisting = viewModel.currentId != -1L

    if (isEditingExisting && note == null) {
        Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
            CircularProgressIndicator(color = MaterialTheme.colorScheme.primary)
        }
        return
    }

    val noteTimestamp = note?.timestamp ?: System.currentTimeMillis()
    val state = rememberNoteEditorState(viewModel, settings, note, onSaveSuccess)

    LaunchedEffect(state.lines.size) {
        if (state.lines.isNotEmpty()) {
            state.listState.scrollToItem(state.lines.lastIndex)
        }
    }

    // 2. Header State
    var selectedCategory by remember(note) {
        mutableStateOf(settings.categories.find { it.name == note?.categoryName } ?: Category("Push", 0xFFFF3B30))
    }
    var learningsValue by remember(note) { mutableStateOf(TextFieldValue(note?.learnings ?: "")) }
    var showLearnings by remember { mutableStateOf(false) }

    // Sync ViewModel
    LaunchedEffect(selectedCategory) { viewModel.currentCategory = selectedCategory }
    LaunchedEffect(learningsValue.text) { viewModel.currentLearnings = learningsValue.text }
    LaunchedEffect(note) { note?.let { viewModel.currentTitle = it.title } }

    // 3. Lifecycle & Back Handling
    BackHandler { state.saveNote(isLastNote, exit = true) }

    val lifecycleOwner = LocalLifecycleOwner.current
    DisposableEffect(lifecycleOwner) {
        val observer = LifecycleEventObserver { _, event ->
            if (event == Lifecycle.Event.ON_STOP) state.saveNote(isLastNote, exit = false)
        }
        lifecycleOwner.lifecycle.addObserver(observer)
        onDispose { lifecycleOwner.lifecycle.removeObserver(observer) }
    }

    // Status Bar styling
    val view = LocalView.current
    SideEffect {
        val window = (view.context as Activity).window
        val controller = WindowInsetsControllerCompat(window, view)
        // Force dark icons if light mode, light icons if dark mode
        controller.isAppearanceLightStatusBars = !settings.darkMode
    }

    // 4. Main Scaffold
    Scaffold(
        containerColor = MaterialTheme.colorScheme.background,
        topBar = {
            // Minimal Transparent Top Bar to allow Header to shine
            TopAppBar(
                colors = TopAppBarDefaults.topAppBarColors(containerColor = Color.Transparent),
                title = {},
                navigationIcon = {
                    IconButton(onClick = { state.saveNote(isLastNote, exit = true) }) {
                        Icon(Icons.Default.ArrowBack, contentDescription = "Back", tint = MaterialTheme.colorScheme.onSurface)
                    }
                },
                actions = {
                    IconButton(onClick = { showLearnings = true }) {
                        Icon(Icons.Default.Menu, contentDescription = "Learnings", tint = MaterialTheme.colorScheme.onSurface)
                    }
                }
            )
        }
    ) { padding ->
        Box(modifier = Modifier.fillMaxSize()) {
            Column(modifier = Modifier.fillMaxSize()) {

                // --- NEW HERO HEADER ---
                EditorHeroHeader(
                    timestamp = noteTimestamp,
                    settings = settings,
                    selectedCategory = selectedCategory,
                    onCategorySelect = {
                        selectedCategory = it
                        state.saved = false
                    },
                    topPadding = padding.calculateTopPadding()
                )

                // --- CONTENT AREA ---
                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .weight(1f)
                        .padding(horizontal = 16.dp)
                ) {
                    Spacer(Modifier.height(16.dp))

                    // The Editor List
                    EditorListSection(state, modifier = Modifier.fillMaxSize())
                }
            }

            // Learnings Popup (Overlay)
            LearningsPopup(
                showLearnings = showLearnings,
                learningsValue = learningsValue,
                onDismiss = { showLearnings = false },
                onValueChange = {
                    learningsValue = it
                    state.saved = false
                }
            )
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\editor\NoteEditorState.kt
=========================================

package com.example.gymtrack.feature.editor

import android.content.Context
import android.content.Intent
import androidx.compose.foundation.lazy.LazyListState
import androidx.compose.foundation.lazy.rememberLazyListState
import androidx.compose.runtime.*
import androidx.compose.ui.focus.FocusRequester
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.TextRange
import androidx.compose.ui.text.input.TextFieldValue
import com.example.gymtrack.core.data.ExerciseFlag
import com.example.gymtrack.core.data.NoteLine
import com.example.gymtrack.core.data.Settings
import com.example.gymtrack.core.util.combineTextAndTimes
import com.example.gymtrack.core.util.formatElapsedMinutesSeconds
import com.example.gymtrack.core.util.formatSecondsToMinutesSeconds
import com.example.gymtrack.core.util.parseDurationSeconds
import com.example.gymtrack.core.util.parseNoteText
import com.example.gymtrack.core.services.NoteTimerService
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.launch

data class NoteRow(
    val id: Long,
    val text: MutableState<TextFieldValue>,
    val flag: MutableState<ExerciseFlag> = mutableStateOf(ExerciseFlag.BILATERAL),
    val focusRequester: FocusRequester = FocusRequester()
)

class NoteEditorState(
    private val viewModel: EditorViewModel,
    private val settings: Settings,
    private val context: Context,
    private val scope: CoroutineScope,
    val listState: LazyListState,
    initialNote: NoteLine?, // Renamed to initialNote to avoid confusion
    private val onSaveSuccess: () -> Unit
) {
    var nextId by mutableStateOf(0L)
    val lines = mutableStateListOf<NoteRow>()
    val timestamps = mutableStateListOf<String>()
    val flags = mutableStateListOf<ExerciseFlag>()

    // Keep track of the latest saved version to prevent overwriting with old data
    private var currentNoteVersion: NoteLine? = initialNote

    private var startTime: Long? = initialNote?.timestamp
    private var lastEnter: Long = System.currentTimeMillis()
    private val noteTimestamp = initialNote?.timestamp ?: System.currentTimeMillis()
    var saved by mutableStateOf(false)

    init {
        val parsed = parseNoteText(initialNote?.text ?: "")

        if (parsed.first.isEmpty()) {
            addLine(NoteRow(nextId++, mutableStateOf(TextFieldValue(""))))
            timestamps.add("")
            flags.add(ExerciseFlag.BILATERAL)
        } else {
            parsed.first.forEachIndexed { idx, txt ->
                // [FIX] Clean regex to remove existing relative times to prevent duplication
                val cleanTxt = if (txt.isNotBlank() && !txt.startsWith(" ")) {
                    txt.replace(Regex("""\s*\(\d+'\d{2}''\)$"""), "")
                } else txt

                addLine(
                    NoteRow(
                        nextId++,
                        mutableStateOf(TextFieldValue(cleanTxt)),
                        mutableStateOf(parsed.third.getOrNull(idx) ?: ExerciseFlag.BILATERAL)
                    )
                )
            }
            timestamps.addAll(parsed.second)
            flags.addAll(parsed.third)
        }

        cleanLists()

        if (initialNote != null) {
            val list = parsed.second
            val lastIdx = list.indexOfLast { it.isNotBlank() }
            val lastSec = if (lastIdx >= 0) parseDurationSeconds(list[lastIdx]).toLong() else 0L
            startTime = initialNote.timestamp
            lastEnter = initialNote.timestamp + lastSec * 1000
        } else {
            lastEnter = System.currentTimeMillis()
        }
    }

    private fun addLine(row: NoteRow, index: Int = lines.size) {
        lines.add(index, row)
    }

    fun onTextChange(index: Int, newValue: TextFieldValue) {
        saved = false
        val row = lines[index]

        // [FIX] Logic to handle "Enter" press
        if (newValue.text.endsWith("\n")) {
            val content = newValue.text.dropLast(1)

            // [FIX] Prevent double timestamps: Check if line already ends with (...)
            // matches (m'ss'') pattern
            val hasTimestamp = content.trim().matches(Regex(".*\\(\\d+'\\d{2}''\\)$"))

            val now = System.currentTimeMillis()
            val diffSec = (now - lastEnter) / 1000

            if (content.isNotBlank()) lastEnter = now

            val rel = formatSecondsToMinutesSeconds(diffSec)
            val isMain = index == 0 || lines.getOrNull(index - 1)?.text?.value?.text?.isBlank() != false

            if (startTime == null && content.isNotBlank() && isMain) startTime = now
            val effectiveStart = startTime ?: now
            val abs = formatElapsedMinutesSeconds(effectiveStart, now, settings)

            // Only append relative time if it doesn't already have one and is a sub-entry
            val formatted = if (content.isNotBlank()) {
                if (isMain) content
                else if (hasTimestamp) content // Keep existing
                else "      $content ($rel)" // Append new
            } else ""

            row.text.value = TextFieldValue(formatted, TextRange(formatted.length))

            ensureListSize(index)
            if (content.isNotBlank()) timestamps[index] = abs

            // Create new line
            val nextIdx = index + 1
            val newRow = NoteRow(nextId++, mutableStateOf(TextFieldValue("")), mutableStateOf(row.flag.value))

            lines.add(nextIdx, newRow)
            if (flags.size <= nextIdx) flags.add(row.flag.value) else flags.add(nextIdx, row.flag.value)
            if (timestamps.size <= nextIdx) timestamps.add("") else timestamps.add(nextIdx, "")

            scope.launch {
                listState.animateScrollToItem(nextIdx)
                newRow.focusRequester.requestFocus()
            }

            // [CRITICAL FIX] AUTOSAVE on new line to prevent data loss if app dies
            saveNote(isLastNote = false, exit = false)

        } else {
            row.text.value = newValue
        }
    }

    fun toggleFlag(index: Int) {
        val row = lines[index]
        val newFlag = row.flag.value.next()
        row.flag.value = newFlag
        ensureListSize(index)
        flags[index] = newFlag
        saved = false
        // [Optional] Autosave on flag toggle too
        saveNote(isLastNote = false, exit = false)
    }

    fun saveNote(isLastNote: Boolean, exit: Boolean) {
        // [FIX] If we just saved and aren't exiting, skip to save resources
        // BUT if it's an autosave (exit=false), we proceed.
        if (saved && !exit) return

        val lastContentIndex = lines.indexOfLast { it.text.value.text.isNotBlank() }
        val range = if (lastContentIndex >= 0) 0..lastContentIndex else IntRange.EMPTY
        val finalStartTime = startTime ?: noteTimestamp

        range.forEach { i ->
            val row = lines[i]
            if (row.text.value.text.isNotBlank() && timestamps.getOrElse(i) { "" }.isBlank()) {
                val nowAbs = formatElapsedMinutesSeconds(finalStartTime, System.currentTimeMillis(), settings)
                ensureListSize(i)
                timestamps[i] = nowAbs
            }
            ensureListSize(i)
            flags[i] = row.flag.value
        }

        val plainContent = range.joinToString("\n") { lines[it].text.value.text }
        val validTimestamps = range.map { timestamps.getOrElse(it) { "" } }
        val validFlags = range.map { flags.getOrElse(it) { ExerciseFlag.BILATERAL } }
        val combined = combineTextAndTimes(plainContent, validTimestamps, validFlags)

        val isNew = currentNoteVersion == null
        val isEmpty = combined.isBlank() && viewModel.currentTitle.isBlank() && viewModel.currentLearnings.isBlank()

        if (isNew && isEmpty) {
            if (exit) onSaveSuccess()
            return
        }

        // [FIX] Update ViewModel immediately so UI is robust
        viewModel.saveNote(combined, settings) {
            if (exit) {
                onSaveSuccess()
            }
            // Update internal version to match saved state
            saved = true
        }

        if (isLastNote && exit) {
            context.stopService(Intent(context, NoteTimerService::class.java))
        }
    }

    private fun ensureListSize(index: Int) {
        while (timestamps.size <= index + 1) timestamps.add("")
        while (flags.size <= index + 1) flags.add(ExerciseFlag.BILATERAL)
    }

    private fun cleanLists() {
        while (timestamps.size < lines.size) timestamps.add("")
        while (timestamps.size > lines.size) timestamps.removeAt(timestamps.lastIndex)
        while (flags.size < lines.size) flags.add(ExerciseFlag.BILATERAL)
        while (flags.size > lines.size) flags.removeAt(flags.lastIndex)
    }
}
@Composable
fun rememberNoteEditorState(
    viewModel: EditorViewModel,
    settings: Settings,
    note: NoteLine?,
    onSaveSuccess: () -> Unit
): NoteEditorState {
    val context = LocalContext.current
    val scope = rememberCoroutineScope()
    val listState = rememberLazyListState()

    return remember(note) {
        NoteEditorState(viewModel, settings, context, scope, listState, note, onSaveSuccess)
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\home\components\ModernNoteCard.kt
=========================================

import androidx.compose.foundation.ExperimentalFoundationApi
import androidx.compose.foundation.border
import androidx.compose.foundation.combinedClickable
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Surface
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.remember
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.gymtrack.core.data.DEFAULT_CATEGORIES
import com.example.gymtrack.core.data.NoteLine
import com.example.gymtrack.core.data.Settings
import com.example.gymtrack.core.util.formatWeekRelativeTime
import com.example.gymtrack.core.util.parseDurationSeconds
import com.example.gymtrack.core.util.parseNoteText

@OptIn(ExperimentalFoundationApi::class)
@Composable
fun ModernNoteCard(
    note: NoteLine,
    isSelected: Boolean,
    onClick: () -> Unit,
    onLongClick: () -> Unit,
    settings: Settings,
) {
    val categoryColor = DEFAULT_CATEGORIES.find { it.name.equals(note.categoryName, ignoreCase = true) }
        ?.let { Color(it.color) } ?: MaterialTheme.colorScheme.onSurface

    val totalMinutes = remember(note.text) {
        val seconds = parseNoteText(note.text).second.mapNotNull {
            if (it.isBlank()) null else parseDurationSeconds(it)
        }.maxOrNull()
        seconds?.div(60)
    }

    // Use Theme Surface
    val containerColor = if (isSelected) categoryColor.copy(alpha = 0.2f) else MaterialTheme.colorScheme.surface
    val borderColor = if (isSelected) categoryColor else Color.Transparent

    Card(
        modifier = Modifier
            .fillMaxWidth()
            .combinedClickable(onClick = onClick, onLongClick = onLongClick)
            .border(width = if (isSelected) 2.dp else 0.dp, color = borderColor, shape = RoundedCornerShape(22.dp)),
        shape = RoundedCornerShape(22.dp),
        colors = CardDefaults.cardColors(containerColor = containerColor),
        elevation = CardDefaults.cardElevation(defaultElevation = 0.dp)
    ) {
        Column(
            modifier = Modifier.padding(18.dp),
            verticalArrangement = Arrangement.SpaceBetween
        ) {
            Text(
                text = (note.categoryName ?: "Workout").uppercase(),
                style = MaterialTheme.typography.titleLarge,
                fontWeight = FontWeight.Black,
                color = categoryColor,
                letterSpacing = (-0.5).sp,
                maxLines = 1
            )

            Spacer(modifier = Modifier.height(14.dp))

            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    text = formatWeekRelativeTime(note.timestamp, settings),
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant,
                    fontWeight = FontWeight.Medium
                )

                if (totalMinutes != null && totalMinutes > 0) {
                    Surface(
                        color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.1f), // Subtle badge
                        shape = RoundedCornerShape(6.dp)
                    ) {
                        Text(
                            text = "${totalMinutes}m",
                            style = MaterialTheme.typography.labelSmall,
                            fontWeight = FontWeight.Bold,
                            color = MaterialTheme.colorScheme.onSurface,
                            modifier = Modifier.padding(horizontal = 6.dp, vertical = 3.dp)
                        )
                    }
                }
            }
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\home\components\WorkoutAlbumCard.kt
=========================================

package com.example.gymtrack.feature.home.components

import androidx.compose.foundation.ExperimentalFoundationApi
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.combinedClickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.runtime.remember
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.gymtrack.core.data.NoteLine
import com.example.gymtrack.core.data.Settings
import com.example.gymtrack.core.util.formatTime
import com.example.gymtrack.core.util.formatWeekRelativeTime
import com.example.gymtrack.core.util.parseDurationSeconds
import com.example.gymtrack.core.util.parseNoteText

@OptIn(ExperimentalFoundationApi::class)
@Composable
fun WorkoutAlbumCard(
    note: NoteLine,
    isSelected: Boolean,
    onClick: () -> Unit,
    onLongClick: () -> Unit,
    settings: Settings
) {
    // [FIX] Dynamic Color Lookup
    // Find the category in settings that matches the note's category name.
    // If not found, default to Gray.
    val categoryColor = remember(note.categoryName, settings.categories) {
        val found = settings.categories.find { it.name == note.categoryName }
        if (found != null) Color(found.color) else Color(0xFF666666) // Default Gray
    }

    val cardBaseColor = if (isSelected) MaterialTheme.colorScheme.surfaceVariant else MaterialTheme.colorScheme.background
    val textColor = MaterialTheme.colorScheme.onSurface

    // Gradient using the dynamic color
    val fadeGradient = remember(categoryColor, cardBaseColor) {
        Brush.verticalGradient(
            colors = listOf(
                categoryColor.copy(alpha = 0.50f),
                cardBaseColor
            )
        )
    }

    // ... (Rest of UI remains identical) ...
    val totalMinutes = remember(note.text) {
        val seconds = parseNoteText(note.text).second.mapNotNull {
            if (it.isBlank()) null else parseDurationSeconds(it)
        }.maxOrNull()
        seconds?.div(60) ?: 0
    }

    val displayTitle = note.title.ifBlank {
        val full = formatWeekRelativeTime(note.timestamp, settings)
        if (full.contains(" ")) full.substringBeforeLast(" ") else full
    }
    val displaySubtitle = if (note.title.isNotBlank()) formatWeekRelativeTime(note.timestamp, settings) else formatTime(note.timestamp, settings)

    Card(
        modifier = Modifier
            .fillMaxWidth()
            .aspectRatio(1.1f)
            .combinedClickable(onClick = onClick, onLongClick = onLongClick)
            .then(if (isSelected) Modifier.border(2.dp, MaterialTheme.colorScheme.primary, RoundedCornerShape(12.dp)) else Modifier),
        shape = RoundedCornerShape(12.dp),
        colors = CardDefaults.cardColors(containerColor = cardBaseColor),
        elevation = CardDefaults.cardElevation(0.dp)
    ) {
        Column(modifier = Modifier.fillMaxSize()) {
            Box(
                modifier = Modifier
                    .weight(1f)
                    .fillMaxWidth()
                    .background(cardBaseColor)
                    .background(fadeGradient)
                    .padding(12.dp)
            ) {
                Text(
                    text = (note.categoryName ?: "Work").take(6).uppercase(),
                    style = MaterialTheme.typography.displayLarge,
                    color = textColor.copy(alpha = 0.1f),
                    fontWeight = FontWeight.Black,
                    fontSize = 50.sp,
                    letterSpacing = (-1).sp,
                    modifier = Modifier.align(Alignment.BottomStart)
                )
            }
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .background(cardBaseColor)
                    .padding(12.dp)
            ) {
                Text(displayTitle, style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold, color = textColor, maxLines = 1, overflow = TextOverflow.Ellipsis)
                Spacer(Modifier.height(6.dp))
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Text(displaySubtitle, style = MaterialTheme.typography.bodySmall, color = textColor.copy(alpha = 0.6f), maxLines = 1)
                    if (totalMinutes > 0) {
                        Surface(color = textColor.copy(alpha = 0.1f), shape = RoundedCornerShape(4.dp)) {
                            Text("${totalMinutes} min", color = textColor.copy(alpha = 0.9f), style = MaterialTheme.typography.labelSmall, fontWeight = FontWeight.Bold, modifier = Modifier.padding(horizontal = 6.dp, vertical = 2.dp))
                        }
                    }
                }
            }
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\home\HomeViewModel.kt
=========================================

package com.example.gymtrack.feature.home

import android.content.Context
import android.net.Uri
import androidx.lifecycle.ViewModel
import androidx.lifecycle.ViewModelProvider
import androidx.lifecycle.viewModelScope
import com.example.gymtrack.core.data.NoteLine
import com.example.gymtrack.core.data.Settings
import com.example.gymtrack.core.data.repository.NoteRepository
import com.example.gymtrack.core.util.exportNote
import com.example.gymtrack.core.util.importNote
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.flow.SharingStarted
import kotlinx.coroutines.flow.stateIn
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import java.io.File
import com.example.gymtrack.core.data.WorkoutRepository
import com.example.gymtrack.core.data.repository.toEntity

class HomeViewModel(
    private val repository: NoteRepository,
    private val workoutRepository: WorkoutRepository
) : ViewModel() {

    val notes = repository.getAllNotes()
        .stateIn(viewModelScope, SharingStarted.Companion.WhileSubscribed(5000), emptyList())

    fun deleteNotes(notes: Set<NoteLine>) {
        viewModelScope.launch {
            // 1. Delete the Text Notes
            repository.deleteNotes(notes)

            // 2. [FIX] Delete the associated Stats
            notes.forEach { note ->
                workoutRepository.deleteWorkout(note.timestamp)
            }
        }
    }

    suspend fun exportNotes(context: Context, notes: Set<NoteLine>, settings: Settings): List<File> {
        return withContext(Dispatchers.IO) {
            notes.map { exportNote(context, it, settings) }
        }
    }

    // [FIX] Added Import Functionality
    fun importNoteFromUri(context: Context, uri: Uri, settings: Settings) {
        viewModelScope.launch(Dispatchers.IO) {
            try {
                // 1. Copy content from Uri to a temporary file
                val inputStream = context.contentResolver.openInputStream(uri) ?: return@launch
                val tempFile = File(context.cacheDir, "temp_import.csv")

                tempFile.outputStream().use { output ->
                    inputStream.copyTo(output)
                }
                inputStream.close()

                // 2. Parse using your existing ImportUtils
                val note = importNote(tempFile, settings)

                if (note != null) {
                    // 1. Save Text
                    repository.saveNote(note)
                    // 2. [FIX] Generate Stats immediately
                    // We map the parsed NoteEntity to sets so they show up in graphs
                    workoutRepository.syncNoteToWorkout(note.toEntity())
                }

                // 4. Cleanup
                tempFile.delete()
            } catch (e: Exception) {
                e.printStackTrace()
            }
        }
    }

    class Factory(
        private val repository: NoteRepository,
        private val workoutRepository: WorkoutRepository
    ) : ViewModelProvider.Factory {
        @Suppress("UNCHECKED_CAST")
        override fun <T : ViewModel> create(modelClass: Class<T>): T {
            return HomeViewModel(repository, workoutRepository) as T
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\home\NotesScreen.kt
=========================================

package com.example.gymtrack.feature.home

import android.net.Uri
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.ExperimentalFoundationApi
import androidx.compose.foundation.background
import androidx.compose.foundation.gestures.detectHorizontalDragGestures
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.grid.GridCells
import androidx.compose.foundation.lazy.grid.GridItemSpan
import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
import androidx.compose.foundation.lazy.grid.items
import androidx.compose.foundation.lazy.grid.rememberLazyGridState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.ArrowBack
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.gymtrack.core.data.Category
import com.example.gymtrack.core.data.NoteLine
import com.example.gymtrack.core.data.Settings
import com.example.gymtrack.feature.home.components.WorkoutAlbumCard

@OptIn(ExperimentalFoundationApi::class, ExperimentalMaterial3Api::class)
@Composable
fun NotesScreen(
    notes: List<NoteLine>,
    selectedNotes: Set<NoteLine> = emptySet(),
    onSelect: (Set<NoteLine>) -> Unit,
    onEdit: (NoteLine) -> Unit,
    onDelete: (Set<NoteLine>) -> Unit,
    onExport: (Set<NoteLine>) -> Unit,
    onCreate: () -> Unit,
    onImport: (Uri) -> Unit, // [FIX] Changed from () -> Unit to (Uri) -> Unit
    onOpenSettings: () -> Unit,
    onOpenStats: () -> Unit,
    onSwipeRight: () -> Unit,
    settings: Settings,
) {
    // [FIX] File Picker Launcher
    val importLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.OpenDocument(),
        onResult = { uri ->
            uri?.let { onImport(it) }
        }
    )

    Scaffold(
        containerColor = MaterialTheme.colorScheme.background,
        floatingActionButton = {
            if (selectedNotes.isEmpty()) {
                FloatingActionButton(
                    onClick = onCreate,
                    containerColor = MaterialTheme.colorScheme.primary,
                    contentColor = MaterialTheme.colorScheme.onPrimary,
                    shape = CircleShape,
                    modifier = Modifier.size(60.dp)
                ) {
                    Icon(Icons.Default.Add, contentDescription = "Add Note", modifier = Modifier.size(30.dp))
                }
            }
        },
        topBar = {
            if (selectedNotes.isEmpty()) {
                // Main Header
                TopAppBar(
                    colors = TopAppBarDefaults.topAppBarColors(
                        containerColor = MaterialTheme.colorScheme.background
                    ),
                    title = {
                        Text(
                            "GymTrack",
                            fontSize = 30.sp,
                            fontWeight = FontWeight.ExtraBold,
                            color = MaterialTheme.colorScheme.onBackground,
                            letterSpacing = (-1).sp
                        )
                    },
                    actions = {
                        IconButton(onClick = onOpenStats) {
                            Icon(Icons.Default.BarChart, contentDescription = "Stats", tint = MaterialTheme.colorScheme.onBackground)
                        }
                        // [FIX] Launch File Picker on click
                        IconButton(onClick = {
                            importLauncher.launch(arrayOf("text/comma-separated-values", "text/csv", "application/csv"))
                        }) {
                            Icon(Icons.Default.UploadFile, contentDescription = "Import", tint = MaterialTheme.colorScheme.onBackground)
                        }
                        IconButton(onClick = onOpenSettings) {
                            Icon(Icons.Default.Settings, contentDescription = "Settings", tint = MaterialTheme.colorScheme.onBackground)
                        }
                    }
                )
            } else {
                // Selection Header (Unchanged)
                TopAppBar(
                    colors = TopAppBarDefaults.topAppBarColors(
                        containerColor = MaterialTheme.colorScheme.surface
                    ),
                    title = { Text("${selectedNotes.size} selected", color = MaterialTheme.colorScheme.onSurface) },
                    navigationIcon = {
                        IconButton(onClick = { onSelect(emptySet()) }) {
                            Icon(Icons.AutoMirrored.Filled.ArrowBack, contentDescription = "Close", tint = MaterialTheme.colorScheme.onSurface)
                        }
                    },
                    actions = {
                        IconButton(onClick = { onDelete(selectedNotes) }) {
                            Icon(Icons.Default.Delete, contentDescription = "Delete", tint = MaterialTheme.colorScheme.error)
                        }
                        IconButton(onClick = { onExport(selectedNotes) }) {
                            Icon(Icons.Default.Download, contentDescription = "Export", tint = MaterialTheme.colorScheme.onSurface)
                        }
                        IconButton(onClick = {
                            if (selectedNotes.size == notes.size) onSelect(emptySet()) else onSelect(notes.toSet())
                        }) {
                            Icon(
                                imageVector = if (selectedNotes.size == notes.size) Icons.Default.ChecklistRtl else Icons.Default.Checklist,
                                contentDescription = "Select All", tint = MaterialTheme.colorScheme.onSurface
                            )
                        }
                    }
                )
            }
        }
    ) { padding ->
        var dragX by remember { mutableStateOf(0f) }
        var newestFirst by remember { mutableStateOf(true) }
        var categoryFilter by remember { mutableStateOf<Category?>(null) }
        var filterExpanded by remember { mutableStateOf(false) }

        val displayNotes = remember(notes, categoryFilter, newestFirst) {
            notes
                .filter { n -> categoryFilter?.let { n.categoryName == it.name } ?: true }
                .let { list -> if (newestFirst) list.sortedByDescending { it.timestamp } else list.sortedBy { it.timestamp } }
        }

        Box(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
                .pointerInput(Unit) {
                    detectHorizontalDragGestures(
                        onDragEnd = { if (dragX > 100f) onSwipeRight(); dragX = 0f }
                    ) { _, dragAmount -> if (dragAmount > 0) dragX += dragAmount }
                }
        ) {
            LazyVerticalGrid(
                columns = GridCells.Adaptive(160.dp),
                state = rememberLazyGridState(),
                contentPadding = PaddingValues(16.dp),
                verticalArrangement = Arrangement.spacedBy(12.dp),
                horizontalArrangement = Arrangement.spacedBy(12.dp),
                modifier = Modifier.fillMaxSize()
            ) {
                // Header (Sort/Filter)
                item(span = { GridItemSpan(maxLineSpan) }) {
                    Row(
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(bottom = 8.dp),
                        horizontalArrangement = Arrangement.End,
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Box {
                            TextButton(onClick = { filterExpanded = true }) {
                                Text(
                                    text = categoryFilter?.name ?: "All Categories",
                                    color = MaterialTheme.colorScheme.onSurfaceVariant,
                                    fontWeight = FontWeight.Medium
                                )
                                Icon(Icons.Default.KeyboardArrowDown, contentDescription = null, tint = MaterialTheme.colorScheme.onSurfaceVariant)
                            }
                            DropdownMenu(
                                expanded = filterExpanded,
                                onDismissRequest = { filterExpanded = false },
                                containerColor = MaterialTheme.colorScheme.surface
                            ) {
                                DropdownMenuItem(
                                    text = { Text("All", color = MaterialTheme.colorScheme.onSurface) },
                                    onClick = { categoryFilter = null; filterExpanded = false }
                                )
                                settings.categories.forEach { cat ->
                                    DropdownMenuItem(
                                        text = { Text(cat.name, color = MaterialTheme.colorScheme.onSurface) },
                                        trailingIcon = { Box(Modifier.size(10.dp).background(Color(cat.color), CircleShape)) },
                                        onClick = { categoryFilter = cat; filterExpanded = false }
                                    )
                                }
                            }
                        }
                        IconButton(onClick = { newestFirst = !newestFirst }) {
                            Icon(Icons.Default.KeyboardArrowDown, contentDescription = "Sort", tint = MaterialTheme.colorScheme.onSurfaceVariant)
                        }
                    }
                }

                items(displayNotes) { note ->
                    val isSelected = selectedNotes.contains(note)
                    WorkoutAlbumCard(
                        note = note,
                        isSelected = isSelected,
                        onClick = {
                            if (selectedNotes.isNotEmpty()) {
                                val newSet = if (isSelected) selectedNotes - note else selectedNotes + note
                                onSelect(newSet)
                            } else {
                                onEdit(note)
                            }
                        },
                        onLongClick = {
                            val newSet = if (isSelected) selectedNotes - note else selectedNotes + note
                            onSelect(newSet)
                        },
                        settings = settings
                    )
                }
            }
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\settings\SettingsScreen.kt
=========================================

package com.example.gymtrack.feature.settings

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Add
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material.icons.filled.Delete
import androidx.compose.material.icons.filled.Refresh
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.toArgb
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.gymtrack.core.data.Category
import com.example.gymtrack.core.data.Settings

private val CardDeepDark = Color(0xFF181818)

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun SettingsScreen(
    settings: Settings,
    onUpdate: (Settings) -> Unit,
    onBack: () -> Unit
) {
    var editingCategory by remember { mutableStateOf<Category?>(null) }

    fun update(block: Settings.() -> Settings) {
        onUpdate(settings.block())
    }

    val backgroundColor = MaterialTheme.colorScheme.background
    val textColor = MaterialTheme.colorScheme.onSurface

    Scaffold(
        containerColor = backgroundColor,
        topBar = {
            TopAppBar(
                title = { Text("Settings", fontWeight = FontWeight.Bold, fontSize = 24.sp) },
                navigationIcon = {
                    IconButton(onClick = onBack) {
                        Icon(Icons.Default.ArrowBack, contentDescription = "Back", tint = textColor)
                    }
                },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = backgroundColor,
                    titleContentColor = textColor
                )
            )
        }
    ) { padding ->
        LazyColumn(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
                .padding(horizontal = 16.dp),
            verticalArrangement = Arrangement.spacedBy(24.dp)
        ) {
            // --- PREFERENCES ---
            item {
                SettingsSectionTitle("Preferences")
                SettingsCard {
                    SettingsSwitchRow("Dark Mode", settings.darkMode) { update { copy(darkMode = it) } }
                    Divider(color = textColor.copy(alpha = 0.1f))
                    SettingsSwitchRow("24-Hour Time", settings.is24Hour) { update { copy(is24Hour = it) } }
                }
            }

            // --- CATEGORIES ---
            item {
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    SettingsSectionTitle("Workout Categories")
                    IconButton(
                        onClick = {
                            val newCat = Category("New Category", randomColor())
                            update { copy(categories = categories + newCat) }
                        }
                    ) {
                        Icon(Icons.Default.Add, contentDescription = "Add", tint = MaterialTheme.colorScheme.primary)
                    }
                }
            }

            items(settings.categories) { cat ->
                CategoryRow(
                    category = cat,
                    textColor = textColor,
                    onEdit = { editingCategory = cat },
                    onDelete = {
                        if (settings.categories.size > 1) {
                            update { copy(categories = categories - cat) }
                        }
                    }
                )
            }

            item { Spacer(Modifier.height(32.dp)) }
        }

        if (editingCategory != null) {
            EditCategoryDialog(
                category = editingCategory!!,
                onDismiss = { editingCategory = null },
                onSave = { updatedCat ->
                    // Replace the old category with the new one
                    val newList = settings.categories.map {
                        if (it == editingCategory) updatedCat else it
                    }
                    update { copy(categories = newList) }
                    editingCategory = null
                }
            )
        }
    }
}

// --- COMPONENTS ---

@Composable
fun EditCategoryDialog(
    category: Category,
    onDismiss: () -> Unit,
    onSave: (Category) -> Unit
) {
    var name by remember { mutableStateOf(category.name) }
    var color by remember { mutableStateOf(category.color) }

    AlertDialog(
        onDismissRequest = onDismiss,
        title = { Text("Edit Category") },
        text = {
            Column {
                OutlinedTextField(
                    value = name,
                    onValueChange = { name = it },
                    label = { Text("Category Name") },
                    singleLine = true
                )
                Spacer(Modifier.height(16.dp))
                Row(verticalAlignment = Alignment.CenterVertically) {
                    // Show color preview
                    Box(Modifier.size(40.dp).clip(CircleShape).background(Color(color)))
                    Spacer(Modifier.width(16.dp))
                    Button(onClick = { color = randomColor() }) {
                        Icon(Icons.Default.Refresh, contentDescription = null)
                        Spacer(Modifier.width(8.dp))
                        Text("New Color")
                    }
                }
            }
        },
        confirmButton = {
            TextButton(onClick = { onSave(category.copy(name = name, color = color)) }) {
                Text("Save")
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) { Text("Cancel") }
        }
    )
}

// [FIXED] Correctly returns a Long compatible with Compose Color(Long)
fun randomColor(): Long {
    val hue = (0..360).random().toFloat()
    // 1. Generate HSV color
    // 2. Convert to ARGB Int (which might be negative)
    // 3. Convert to Long and Mask with 0xFFFFFFFF to make it a valid positive Unsigned Long
    return Color.hsv(hue, 0.8f, 0.9f).toArgb().toLong() and 0xFFFFFFFF
}

@Composable
fun SettingsSectionTitle(text: String) {
    Text(
        text = text,
        style = MaterialTheme.typography.titleMedium,
        fontWeight = FontWeight.Bold,
        color = MaterialTheme.colorScheme.onSurface,
        modifier = Modifier.padding(bottom = 8.dp, start = 4.dp)
    )
}

@Composable
fun SettingsCard(content: @Composable ColumnScope.() -> Unit) {
    val isDark = MaterialTheme.colorScheme.background.run { red < 0.5 && green < 0.5 && blue < 0.5 }
    val cardColor = if (isDark) CardDeepDark else MaterialTheme.colorScheme.surface
    Card(
        colors = CardDefaults.cardColors(containerColor = cardColor),
        shape = RoundedCornerShape(12.dp),
        elevation = CardDefaults.cardElevation(if(isDark) 0.dp else 2.dp)
    ) {
        Column(modifier = Modifier.fillMaxWidth()) { content() }
    }
}

@Composable
fun SettingsSwitchRow(title: String, checked: Boolean, onCheckedChange: (Boolean) -> Unit) {
    Row(
        modifier = Modifier.fillMaxWidth().clickable { onCheckedChange(!checked) }.padding(16.dp),
        horizontalArrangement = Arrangement.SpaceBetween,
        verticalAlignment = Alignment.CenterVertically
    ) {
        Text(title, color = MaterialTheme.colorScheme.onSurface, fontWeight = FontWeight.Medium)
        Switch(checked = checked, onCheckedChange = onCheckedChange)
    }
}

@Composable
fun CategoryRow(
    category: Category,
    textColor: Color,
    onEdit: () -> Unit,
    onDelete: () -> Unit
) {
    val isDark = MaterialTheme.colorScheme.background.run { red < 0.5 && green < 0.5 && blue < 0.5 }
    val cardColor = if (isDark) CardDeepDark else MaterialTheme.colorScheme.surface

    Card(
        colors = CardDefaults.cardColors(containerColor = cardColor),
        shape = RoundedCornerShape(12.dp),
        modifier = Modifier.fillMaxWidth().padding(vertical = 4.dp).clickable { onEdit() },
        elevation = CardDefaults.cardElevation(if(isDark) 0.dp else 2.dp)
    ) {
        Row(
            modifier = Modifier.padding(16.dp).fillMaxWidth(),
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.SpaceBetween
        ) {
            Row(verticalAlignment = Alignment.CenterVertically) {
                Box(Modifier.size(12.dp).clip(CircleShape).background(Color(category.color)))
                Spacer(Modifier.width(16.dp))
                Text(category.name, fontWeight = FontWeight.Bold, color = textColor, fontSize = 16.sp)
            }
            IconButton(onClick = onDelete) {
                Icon(Icons.Default.Delete, contentDescription = "Delete", tint = MaterialTheme.colorScheme.error.copy(alpha = 0.6f))
            }
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\stats\components\charts\AverageCategoryDurationChart.kt
=========================================

package com.example.gymtrack.feature.stats.components.charts

import androidx.compose.foundation.Canvas
import androidx.compose.foundation.layout.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.geometry.CornerRadius
import androidx.compose.ui.geometry.Offset
import androidx.compose.ui.geometry.Size
import androidx.compose.ui.platform.LocalDensity
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.gymtrack.feature.stats.StatsState

@Composable
fun AverageCategoryDurationChart(
    state: StatsState,
    modifier: Modifier = Modifier
) {
    val data = state.averageDurations.toList()
        .sortedByDescending { it.second }
        .filter { it.second > 0 }

    Column(modifier.fillMaxWidth()) {
        Text(
            "Avg Duration (min)",
            style = MaterialTheme.typography.titleMedium,
            fontWeight = FontWeight.Bold,
            color = MaterialTheme.colorScheme.onSurface
        )
        Spacer(Modifier.height(16.dp))

        if (data.isEmpty()) {
            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .height(200.dp),
                contentAlignment = Alignment.Center
            ) {
                Text(
                    "No duration data available",
                    color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.4f),
                    style = MaterialTheme.typography.bodyMedium
                )
            }
            return
        }

        val theme = rememberChartTheme()
        val density = LocalDensity.current
        val textPaint = makeTextPaint(theme.label, with(density) { 10.sp.toPx() })
        val scaleY = buildScaleY(data.map { it.second })

        Canvas(modifier = Modifier.fillMaxWidth().height(200.dp)) {
            val layout = ChartLayout()
            val chartW = layout.width(size.width)
            val chartH = layout.height(size.height)
            val x0 = layout.originX()
            val y0 = layout.originY(size.height)

            // Draw Grid
            drawYGridAndLabels(scaleY, theme, layout, textPaint)

            val n = data.size
            val groupGap = chartW / (n * 2f).coerceAtLeast(1f)
            val barW = groupGap.coerceAtMost(60f)

            data.forEachIndexed { idx, (cat, avg) ->
                val slotWidth = chartW / n
                val xCenter = x0 + (slotWidth * idx) + (slotWidth / 2)
                val xLeft = xCenter - (barW / 2)
                val barH = chartH * (avg / scaleY.top)

                // Rounded Green Bar
                drawRoundRect(
                    color = theme.primary.copy(alpha = 0.9f),
                    topLeft = Offset(xLeft, y0 - barH),
                    size = Size(barW, barH),
                    cornerRadius = CornerRadius(6f, 6f)
                )

                val label = if (cat.length > 3) cat.take(3) else cat
                drawXTickLabel(label, xCenter, y0, textPaint)
            }
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\stats\components\charts\CategoryChart.kt
=========================================

package com.example.gymtrack.feature.stats.components.charts

import androidx.compose.foundation.Canvas
import androidx.compose.foundation.layout.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.geometry.CornerRadius
import androidx.compose.ui.geometry.Offset
import androidx.compose.ui.geometry.Size
import androidx.compose.ui.platform.LocalDensity
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.gymtrack.feature.stats.StatsState

@Composable
fun CategoryChart(
    state: StatsState,
    modifier: Modifier = Modifier
) {
    val data = state.categoryCounts.toList()
        .sortedByDescending { it.second }
        .filter { it.second > 0 }

    if (data.isEmpty()) {
        Box(modifier.fillMaxWidth().height(200.dp))
        return
    }

    val theme = rememberChartTheme()
    val density = LocalDensity.current
    val textPaint = makeTextPaint(theme.label, with(density) { 10.sp.toPx() })

    val scaleY = buildScaleY(data.map { it.second.toFloat() })

    Column(modifier.fillMaxWidth()) {
        Text("Workouts per Category", style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold, color = MaterialTheme.colorScheme.onSurface)
        Spacer(Modifier.height(16.dp))

        Canvas(modifier = Modifier.fillMaxWidth().height(200.dp)) {
            val layout = ChartLayout()
            val chartW = layout.width(size.width)
            val chartH = layout.height(size.height)
            val x0 = layout.originX()
            val y0 = layout.originY(size.height)

            // Draw Grid & Labels (Now called directly on DrawScope)
            drawYGridAndLabels(scaleY, theme, layout, textPaint)

            val n = data.size
            val groupGap = chartW / (n * 2f).coerceAtLeast(1f)
            val barW = groupGap.coerceAtMost(80f)

            data.forEachIndexed { idx, (cat, count) ->
                val slotWidth = chartW / n
                val xCenter = x0 + (slotWidth * idx) + (slotWidth / 2)
                val xLeft = xCenter - (barW / 2)
                val barH = chartH * (count / scaleY.top)

                // Draw Rounded Bar
                drawRoundRect(
                    color = theme.primary,
                    topLeft = Offset(xLeft, y0 - barH),
                    size = Size(barW, barH),
                    cornerRadius = CornerRadius(8f, 8f)
                )

                // Draw X Label
                val label = if (cat.length > 4) cat.take(3) + "." else cat
                drawXTickLabel(label, xCenter, y0, textPaint)
            }
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\stats\components\charts\ChartPrimitives.kt
=========================================

package com.example.gymtrack.feature.stats.components.charts

import android.graphics.Paint
import androidx.compose.foundation.isSystemInDarkTheme
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.Composable
import androidx.compose.runtime.remember
import androidx.compose.ui.geometry.Offset
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.Path
import androidx.compose.ui.graphics.drawscope.DrawScope
import androidx.compose.ui.graphics.nativeCanvas
import androidx.compose.ui.graphics.toArgb
import kotlin.math.ceil

// --- THEME ---
val SpotifyGreen = Color(0xFF1DB954)

data class ChartTheme(
    val label: Color,
    val grid: Color,
    val axis: Color,
    val primary: Color,
    val background: Color
)

@Composable
fun rememberChartTheme(): ChartTheme {
    val isDark = isSystemInDarkTheme()
    val colorScheme = MaterialTheme.colorScheme

    // Use deep dark background in dark mode, surface in light mode
    val bg = if (isDark) Color(0xFF181818) else colorScheme.surface

    return remember(isDark, colorScheme) {
        ChartTheme(
            label = if (isDark) Color.White.copy(alpha = 0.6f) else Color.Black.copy(alpha = 0.6f),
            grid = if (isDark) Color.White.copy(alpha = 0.05f) else Color.Black.copy(alpha = 0.05f),
            axis = Color.Transparent,
            primary = SpotifyGreen,
            background = bg
        )
    }
}

// --- LAYOUT & SCALING ---

data class ChartLayout(
    val leftPad: Float = 60f,
    val rightPad: Float = 16f,
    val topPad: Float = 16f,
    val bottomPad: Float = 32f
) {
    fun width(totalW: Float) = totalW - leftPad - rightPad
    fun height(totalH: Float) = totalH
    fun originX() = leftPad
    fun originY(totalH: Float) = totalH - bottomPad
}

data class ScaleY(val min: Float, val max: Float, val range: Float, val top: Float) {
    fun yToPx(value: Float, height: Float, topPad: Float): Float {
        if (top == 0f) return height
        val fraction = value / top
        return height - (fraction * (height - topPad))
    }
}

fun buildScaleY(values: List<Float>): ScaleY {
    if (values.isEmpty()) return ScaleY(0f, 10f, 10f, 10f)
    val maxVal = values.maxOrNull() ?: 0f
    val top = if (maxVal == 0f) 10f else ceil(maxVal * 1.2f / 5f) * 5f
    return ScaleY(0f, top, top, top)
}

fun makeTextPaint(color: Color, textSizePx: Float): Paint {
    return Paint().apply {
        this.color = color.toArgb()
        this.textSize = textSizePx
        this.isAntiAlias = true
    }
}

// --- DRAWING PRIMITIVES (Fixed as DrawScope Extensions) ---

// Fixes "drawAxes" or "drawYGridAndLabels" unresolved errors
fun DrawScope.drawYGridAndLabels(
    scale: ScaleY,
    theme: ChartTheme,
    layout: ChartLayout,
    textPaint: Paint
) {
    val steps = 5
    val stepVal = scale.top / steps
    val xStart = layout.originX()
    val xEnd = size.width - layout.rightPad
    val yOrigin = layout.originY(size.height)

    for (i in 0..steps) {
        val value = stepVal * i
        val y = scale.yToPx(value, yOrigin, layout.topPad)

        // Draw Grid Line (Compose)
        drawLine(
            color = theme.grid,
            start = Offset(xStart, y),
            end = Offset(xEnd, y),
            strokeWidth = 1f
        )

        // Draw Label (Native)
        val label = if (value % 1.0f == 0f) value.toInt().toString() else String.format("%.1f", value)
        val p = textPaint
        val w = p.measureText(label)
        // Draw text slightly to the left of the Y-axis
        drawContext.canvas.nativeCanvas.drawText(label, xStart - w - 12f, y + (p.textSize / 3), p)
    }
}

// Fixes "drawXTickLabel" unresolved error
fun DrawScope.drawXTickLabel(
    label: String,
    x: Float,
    yOrigin: Float,
    textPaint: Paint
) {
    val p = textPaint
    val w = p.measureText(label)
    // Draw text centered at X, below Y-axis
    drawContext.canvas.nativeCanvas.drawText(label, x - (w / 2), yOrigin + p.textSize + 12f, p)
}

// --- PATH HELPERS ---

fun createSmoothPath(points: List<Pair<Float, Float>>): Path {
    val path = Path()
    if (points.isEmpty()) return path
    path.moveTo(points.first().first, points.first().second)
    for (i in 0 until points.size - 1) {
        val p0 = points[i]
        val p1 = points[i + 1]
        val controlX1 = (p0.first + p1.first) / 2f
        val controlY1 = p0.second
        val controlX2 = (p0.first + p1.first) / 2f
        val controlY2 = p1.second
        path.cubicTo(controlX1, controlY1, controlX2, controlY2, p1.first, p1.second)
    }
    return path
}

fun createFillPath(linePath: Path, width: Float, height: Float): Path {
    val fillPath = Path()
    fillPath.addPath(linePath)
    fillPath.lineTo(width, height)
    fillPath.lineTo(0f, height)
    fillPath.close()
    return fillPath
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\stats\components\charts\ExerciseProgressChart.kt
=========================================

package com.example.gymtrack.feature.stats.components.charts

import androidx.compose.foundation.Canvas
import androidx.compose.foundation.layout.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.geometry.Offset
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.drawscope.Stroke
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import com.example.gymtrack.core.data.ExerciseWithCount
import com.example.gymtrack.core.data.GraphPoint
import com.example.gymtrack.core.data.WorkoutRepository
import com.example.gymtrack.feature.stats.TimeRange
import kotlinx.coroutines.flow.flowOf
import java.text.SimpleDateFormat
import java.util.*
import java.util.concurrent.TimeUnit

// ... (calculateOutliers and ExerciseProgressChartGraph remain exactly the same as before) ...
// [Use previous version of these functions]
private fun calculateOutliers(data: List<GraphPoint>): List<GraphPoint> {
    if (data.size < 5) return emptyList()
    val values = data.map { it.avgVal }.sorted()
    val q1 = values[values.size / 4]
    val q3 = values[values.size * 3 / 4]
    val iqr = q3 - q1
    val lower = q1 - 1.5f * iqr
    val upper = q3 + 1.5f * iqr
    return data.filter { it.avgVal < lower || it.avgVal > upper }
}

@Composable
private fun ExerciseProgressChartGraph(
    dataPoints: List<GraphPoint>,
    anomalies: List<GraphPoint>,
    modifier: Modifier = Modifier
) {
    if (dataPoints.isEmpty()) {
        Box(modifier.height(200.dp).fillMaxWidth(), contentAlignment = Alignment.Center) {
            Text("No data for this period", color = Color.Gray)
        }
        return
    }

    val yValues = dataPoints.map { it.avgVal }
    val scaleY = buildScaleY(yValues)

    val minTime = dataPoints.minOf { it.originTimestamp }
    val maxTime = dataPoints.maxOf { it.originTimestamp }
    val timeRange = (maxTime - minTime).coerceAtLeast(1L)

    val theme = rememberChartTheme()
    val dateFormatter = remember { SimpleDateFormat("MMM d", Locale.getDefault()) }
    val textPaint = makeTextPaint(theme.label, 30f)

    Column(modifier.fillMaxWidth()) {
        Canvas(modifier = modifier) {
            val layout = ChartLayout()
            val chartW = layout.width(size.width)
            val chartH = layout.height(size.height)
            val x0 = layout.originX()
            val y0 = layout.originY(size.height)

            drawYGridAndLabels(scaleY, theme, layout, textPaint)

            val points = dataPoints.map { point ->
                val fractionX = (point.originTimestamp - minTime) / timeRange.toFloat()
                val x = x0 + fractionX * chartW
                val y = scaleY.yToPx(point.avgVal, y0, layout.topPad)
                x to y
            }

            val linePath = createSmoothPath(points)
            val fillPath = createFillPath(linePath, size.width, y0)

            drawPath(
                path = fillPath,
                brush = Brush.verticalGradient(
                    colors = listOf(theme.primary.copy(alpha = 0.3f), Color.Transparent),
                    startY = layout.topPad,
                    endY = y0
                )
            )

            drawPath(
                path = linePath,
                color = theme.primary,
                style = Stroke(width = 6f)
            )

            // Anomalies
            val anomalySet = anomalies.map { it.originTimestamp }.toSet()
            points.zip(dataPoints).forEach { (coord, raw) ->
                if (raw.originTimestamp in anomalySet) {
                    drawCircle(Color.Red, radius = 8f, center = Offset(coord.first, coord.second))
                    drawCircle(Color.White, radius = 4f, center = Offset(coord.first, coord.second))
                }
            }

            drawXTickLabel(dateFormatter.format(Date(minTime)), x0, y0, textPaint)
            drawXTickLabel(dateFormatter.format(Date(maxTime)), x0 + chartW, y0, textPaint)
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun ExerciseProgressCard(
    repository: WorkoutRepository?,
    timeRange: TimeRange,
    modifier: Modifier = Modifier,
) {
    // [FIX] Strict "Last X Days" math
    val cutoffTimestamp = remember(timeRange) {
        if (timeRange == TimeRange.ALL_TIME) {
            0L
        } else {
            System.currentTimeMillis() - TimeUnit.DAYS.toMillis(timeRange.days.toLong())
        }
    }

    val allExercises by (repository?.getExercisesSortedByCount(cutoffTimestamp)
        ?: remember { flowOf(emptyList()) })
        .collectAsState(initial = emptyList())

    var selectedExercise by remember { mutableStateOf<ExerciseWithCount?>(null) }
    var expandedDropdown by remember { mutableStateOf(false) }

    LaunchedEffect(allExercises) {
        val currentInList = allExercises.find { it.exerciseId == selectedExercise?.exerciseId }
        if (currentInList != null) {
            selectedExercise = currentInList
        } else if (allExercises.isNotEmpty()) {
            selectedExercise = allExercises.first()
        } else {
            selectedExercise = null
        }
    }

    val fullGraphData by remember(selectedExercise) {
        selectedExercise?.let { repository?.getWeightHistory(it.exerciseId) }
            ?: flowOf(emptyList())
    }.collectAsState(initial = emptyList())

    val filteredGraphData = remember(fullGraphData, cutoffTimestamp) {
        if (cutoffTimestamp == 0L) fullGraphData
        else fullGraphData.filter { it.originTimestamp >= cutoffTimestamp }
    }

    val anomalies = remember(filteredGraphData) { calculateOutliers(filteredGraphData) }

    Card(
        colors = CardDefaults.cardColors(containerColor = Color(0xFF121212)),
        shape = androidx.compose.foundation.shape.RoundedCornerShape(12.dp),
        modifier = modifier.fillMaxWidth()
    ) {
        Column(Modifier.padding(16.dp)) {
            Text("Exercise Progress", style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold, color = Color.White)
            Spacer(Modifier.height(12.dp))

            ExposedDropdownMenuBox(
                expanded = expandedDropdown,
                onExpandedChange = { expandedDropdown = !expandedDropdown }
            ) {
                OutlinedTextField(
                    modifier = Modifier.menuAnchor().fillMaxWidth(),
                    readOnly = true,
                    value = selectedExercise?.let { "${it.name} (${it.setTotalCount} sets)" } ?: "No exercises found",
                    onValueChange = {},
                    trailingIcon = { ExposedDropdownMenuDefaults.TrailingIcon(expandedDropdown) },
                    colors = OutlinedTextFieldDefaults.colors(
                        focusedTextColor = Color.White,
                        unfocusedTextColor = Color.White,
                        focusedBorderColor = SpotifyGreen,
                        unfocusedBorderColor = Color.White.copy(alpha = 0.2f)
                    )
                )
                DropdownMenu(
                    expanded = expandedDropdown,
                    onDismissRequest = { expandedDropdown = false }
                ) {
                    allExercises.forEach { exercise ->
                        DropdownMenuItem(
                            text = { Text("${exercise.name} (${exercise.setTotalCount} sets)") },
                            onClick = {
                                selectedExercise = exercise
                                expandedDropdown = false
                            }
                        )
                    }
                }
            }

            if (anomalies.isNotEmpty()) {
                Spacer(Modifier.height(12.dp))
                Text(
                    "âš ï¸ ${anomalies.size} Anomalies Detected",
                    color = MaterialTheme.colorScheme.error,
                    style = MaterialTheme.typography.labelMedium,
                    fontWeight = FontWeight.Bold
                )
            }

            Spacer(Modifier.height(16.dp))

            ExerciseProgressChartGraph(
                dataPoints = filteredGraphData,
                anomalies = anomalies,
                modifier = Modifier.fillMaxWidth().height(200.dp)
            )
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\stats\components\charts\LearningsOverview.kt
=========================================

package com.example.gymtrack.feature.stats.components.charts

import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Surface
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import com.example.gymtrack.core.data.NoteLine
import com.example.gymtrack.core.data.Settings
import com.example.gymtrack.core.util.formatRelativeTime

@Composable
fun LearningsOverview(notes: List<NoteLine>, settings: Settings) {
    val items = notes.flatMap { note ->
        val time = formatRelativeTime(note.timestamp, settings)
        val category = note.categoryName ?: "Other"
        note.learnings.split("\n").mapNotNull { line ->
            val trimmed = line.trim()
            if (trimmed.isEmpty()) null else Triple(trimmed, time, category)
        }
    }

    if (items.isEmpty()) return

    Column(modifier = Modifier.fillMaxWidth()) {
        Text("Learnings", style = MaterialTheme.typography.titleLarge)
        Spacer(Modifier.height(12.dp))
        items.forEach { (text, time, cat) ->
            Row(
                verticalAlignment = Alignment.CenterVertically,
                modifier = Modifier.padding(vertical = 4.dp)
            ) {
                Surface(
                    shape = RoundedCornerShape(16.dp),
                    color = MaterialTheme.colorScheme.secondaryContainer,
                    tonalElevation = 2.dp
                ) {
                    Text(
                        text,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onSecondaryContainer,
                        modifier = Modifier.padding(horizontal = 12.dp, vertical = 8.dp)
                    )
                }
                Spacer(Modifier.width(8.dp))
                Column {
                    Text(time, style = MaterialTheme.typography.bodySmall)
                    Text(cat, style = MaterialTheme.typography.bodySmall)
                }
            }
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\stats\components\charts\SetsDistributionChart.kt
=========================================

package com.example.gymtrack.feature.stats.components.charts

import androidx.compose.foundation.Canvas
import androidx.compose.foundation.layout.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.geometry.CornerRadius
import androidx.compose.ui.geometry.Offset
import androidx.compose.ui.geometry.Size
import androidx.compose.ui.graphics.nativeCanvas
import androidx.compose.ui.platform.LocalDensity
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp

@Composable
fun SetsDistributionChart(
    topExercises: List<Pair<String, Int>>,
    modifier: Modifier = Modifier
) {
    if (topExercises.isEmpty()) {
        Box(modifier.fillMaxWidth().height(200.dp))
        return
    }

    val theme = rememberChartTheme()
    val density = LocalDensity.current
    val labelPaint = makeTextPaint(theme.label, with(density) { 11.sp.toPx() })
    val countPaint = makeTextPaint(theme.label, with(density) { 10.sp.toPx() })

    // Scale based on max count
    val maxCount = topExercises.maxOf { it.second }.toFloat()

    Column(modifier.fillMaxWidth()) {
        Text(
            "Top Exercises (Sets)",
            style = MaterialTheme.typography.titleMedium,
            fontWeight = FontWeight.Bold,
            color = MaterialTheme.colorScheme.onSurface
        )
        Spacer(Modifier.height(16.dp))

        Canvas(modifier = Modifier.fillMaxWidth().height(200.dp)) {
            val barHeight = 24.dp.toPx()
            val gap = 12.dp.toPx()
            val startY = 10f
            val maxBarWidth = size.width - 40f // Leave space for count label

            topExercises.forEachIndexed { i, (name, count) ->
                val y = startY + i * (barHeight + gap)

                // 1. Draw Exercise Name (Above Bar)
                drawContext.canvas.nativeCanvas.drawText(name, 0f, y, labelPaint)

                // 2. Draw Bar (Below Name)
                val barY = y + 10f
                val width = (count / maxCount) * maxBarWidth

                drawRoundRect(
                    color = theme.primary,
                    topLeft = Offset(0f, barY),
                    size = Size(width, barHeight),
                    cornerRadius = CornerRadius(4f, 4f)
                )

                // 3. Draw Count Label (Right of bar)
                drawContext.canvas.nativeCanvas.drawText(
                    count.toString(),
                    width + 12f,
                    barY + barHeight - 6f,
                    countPaint
                )
            }
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\stats\components\charts\TimeOfDayHeatMap.kt
=========================================

package com.example.gymtrack.feature.stats.components.charts

import androidx.compose.foundation.Canvas
import androidx.compose.foundation.layout.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.geometry.Offset
import androidx.compose.ui.geometry.Size
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.nativeCanvas
import androidx.compose.ui.platform.LocalDensity
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp

@Composable
fun TimeOfDayHeatmap(
    data: Array<IntArray>,
    modifier: Modifier = Modifier
) {
    val theme = rememberChartTheme()
    val density = LocalDensity.current
    val labelPaint = makeTextPaint(theme.label, with(density) { 10.sp.toPx() })
    val maxCount = data.maxOf { it.maxOrNull() ?: 0 }.coerceAtLeast(1)

    fun getCellColor(value: Int): Color {
        if (value == 0) return Color(0xFF1E1E1E) // Empty cell
        val fraction = value.toFloat() / maxCount
        val alpha = when {
            fraction < 0.25f -> 0.2f
            fraction < 0.5f -> 0.4f
            fraction < 0.75f -> 0.7f
            else -> 1.0f
        }
        return SpotifyGreen.copy(alpha = alpha)
    }

    val dayNames = listOf("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")

    Column(modifier.fillMaxWidth()) {
        Text("Training Time", style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold, color = MaterialTheme.colorScheme.onSurface)
        Spacer(Modifier.height(12.dp))

        Canvas(modifier = Modifier.fillMaxWidth().height(240.dp)) {
            val layout = ChartLayout(leftPad = 60f, bottomPad = 40f)
            val chartW = layout.width(size.width)
            val chartH = layout.height(size.height)
            val x0 = layout.originX()
            val y0 = layout.topPad

            val cellW = chartW / 24f
            val cellH = chartH / 7f
            val spacing = 2f

            // Cells
            for (d in 0 until 7) {
                for (h in 0 until 24) {
                    val count = data[d][h]
                    val x = x0 + h * cellW
                    val y = y0 + d * cellH

                    drawRect(
                        color = getCellColor(count),
                        topLeft = Offset(x, y),
                        size = Size(cellW - spacing, cellH - spacing)
                    )
                }
            }

            // Labels
            for (d in 0 until 7) {
                val y = y0 + d * cellH + cellH / 1.5f
                drawContext.canvas.nativeCanvas.drawText(dayNames[d], 0f, y, labelPaint)
            }

            for (h in 0..24 step 6) {
                val x = x0 + h * cellW
                // Using DrawScope extension manually here if needed, or raw text
                drawContext.canvas.nativeCanvas.drawText("${h}h", x, y0 + chartH + 30f, labelPaint)
            }
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\stats\components\charts\WorkoutDurationTrendChart.kt
=========================================

package com.example.gymtrack.feature.stats.components.charts

import androidx.compose.foundation.Canvas
import androidx.compose.foundation.layout.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.drawscope.Stroke
import androidx.compose.ui.platform.LocalDensity
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.gymtrack.core.data.NoteLine
import com.example.gymtrack.core.util.parseDurationSeconds
import com.example.gymtrack.core.util.parseNoteText
import java.text.SimpleDateFormat
import java.util.Calendar
import java.util.Locale

@Composable
fun WorkoutDurationTrendChart(
    notes: List<NoteLine>,
    showRollingAvg: Boolean = true,
    modifier: Modifier = Modifier
) {
    fun isoWeekStart(ts: Long): Long {
        val c = Calendar.getInstance().apply {
            timeInMillis = ts
            firstDayOfWeek = Calendar.MONDAY
            minimalDaysInFirstWeek = 4
        }
        val dow = (c.get(Calendar.DAY_OF_WEEK) + 5) % 7
        c.add(Calendar.DAY_OF_YEAR, -dow)
        c.set(Calendar.HOUR_OF_DAY, 0); c.set(Calendar.MINUTE, 0); c.set(Calendar.SECOND, 0); c.set(Calendar.MILLISECOND, 0)
        return c.timeInMillis
    }

    fun noteMin(n: NoteLine): Float? =
        parseNoteText(n.text).second
            .mapNotNull { if (it.isBlank()) null else parseDurationSeconds(it) }
            .maxOrNull()?.div(60f)

    // Aggregate Data
    val weekly = notes
        .groupBy { isoWeekStart(it.timestamp) }
        .toSortedMap()
        .map { (t, list) ->
            val mins = list.mapNotNull { noteMin(it) }
            t to (if (mins.isEmpty()) 0f else mins.average().toFloat())
        }

    if (weekly.isEmpty()) {
        Box(modifier.fillMaxWidth().height(200.dp)) {
            Text("No data", color = Color.Gray)
        }
        return
    }

    val scaleY = buildScaleY(weekly.map { it.second })
    val theme = rememberChartTheme()
    val density = LocalDensity.current
    val textPaint = makeTextPaint(theme.label, with(density) { 10.sp.toPx() })
    val df = SimpleDateFormat("dd MMM", Locale.getDefault())

    Column(modifier.fillMaxWidth()) {
        Text("Workout Duration (Weekly)", style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold, color = MaterialTheme.colorScheme.onSurface)
        Spacer(Modifier.height(16.dp))

        Canvas(modifier = Modifier.fillMaxWidth().height(200.dp)) {
            val layout = ChartLayout()
            val chartW = layout.width(size.width)
            val chartH = layout.height(size.height)
            val x0 = layout.originX()
            val y0 = layout.originY(size.height)

            // Draw Grid
            drawYGridAndLabels(scaleY, theme, layout, textPaint)

            val n = weekly.size
            val dx = if (n <= 1) chartW else chartW / (n - 1).toFloat()

            // Calculate Points
            val points = weekly.mapIndexed { i, pair ->
                val x = x0 + dx * i
                val y = scaleY.yToPx(pair.second, y0, layout.topPad)
                x to y
            }

            // Draw Fill (Gradient)
            val linePath = createSmoothPath(points)
            val fillPath = createFillPath(linePath, size.width, y0)

            drawPath(
                path = fillPath,
                brush = Brush.verticalGradient(
                    colors = listOf(theme.primary.copy(alpha = 0.3f), Color.Transparent),
                    startY = layout.topPad,
                    endY = y0
                )
            )

            // Draw Line
            drawPath(
                path = linePath,
                color = theme.primary,
                style = Stroke(width = 6f)
            )

            // Draw X Labels (First and Last)
            drawXTickLabel(df.format(weekly.first().first), x0, y0, textPaint)
            if (n > 1) {
                drawXTickLabel(df.format(weekly.last().first), x0 + chartW, y0, textPaint)
            }
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\stats\components\MetricCard.kt
=========================================

package com.example.gymtrack.feature.stats.components

import androidx.compose.foundation.layout.*
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.unit.dp

@Composable
fun MetricCard(
    title: String,
    value: String,
    icon: ImageVector,
    modifier: Modifier = Modifier
) {
    Card(modifier = modifier) {
        Column(
            modifier = Modifier.padding(16.dp),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Icon(imageVector = icon, contentDescription = null)
            Spacer(modifier = Modifier.height(8.dp))
            Text(text = value, style = MaterialTheme.typography.headlineMedium)
            Text(text = title, style = MaterialTheme.typography.bodyMedium)
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\stats\components\StatsOverview.kt
=========================================

package com.example.gymtrack.feature.stats.components

import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.FitnessCenter
import androidx.compose.material.icons.filled.List
import androidx.compose.runtime.Composable
import androidx.compose.runtime.remember
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import com.example.gymtrack.core.data.Note
import com.example.gymtrack.core.util.WorkoutParser

@Composable
fun StatsOverview(notes: List<Note>) {
    // We remember the parser to avoid recreating it on every recomposition
    val parser = remember { WorkoutParser() }

    val (totalVolume, totalSets) = remember(notes) {
        var vol = 0.0
        var sets = 0

        notes.forEach { note ->
            // Parse the full workout text using the robust parser
            val parsedSets = parser.parseWorkout(note.text)

            // Add to totals
            sets += parsedSets.size
            vol += parsedSets.sumOf { (it.weight * it.reps).toDouble() }
        }

        vol to sets
    }

    Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.spacedBy(16.dp)
    ) {
        MetricCard(
            title = "Total Volume",
            value = "${(totalVolume / 1000).toInt()}k kg",
            icon = Icons.Default.FitnessCenter,
            modifier = Modifier.weight(1f)
        )
        MetricCard(
            title = "Total Sets",
            value = totalSets.toString(),
            icon = Icons.Default.List,
            modifier = Modifier.weight(1f)
        )
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\stats\StatsScreen.kt
=========================================

package com.example.gymtrack.feature.stats

import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material.icons.filled.ArrowDropDown
import androidx.compose.material.icons.filled.CalendarToday
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.gymtrack.core.data.Settings
import com.example.gymtrack.core.data.WorkoutRepository
import com.example.gymtrack.feature.stats.components.charts.*

private val CardDeepDark = Color(0xFF121212)

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun StatsScreen(
    state: StatsState,
    workoutRepository: WorkoutRepository,
    settings: Settings,
    onTimeRangeSelected: (TimeRange) -> Unit,
    onBack: () -> Unit
) {
    val backgroundColor = MaterialTheme.colorScheme.background
    val textColor = MaterialTheme.colorScheme.onSurface
    var rangeMenuExpanded by remember { mutableStateOf(false) }

    Scaffold(
        containerColor = backgroundColor,
        topBar = {
            TopAppBar(
                title = { Text("Statistics", fontWeight = FontWeight.Bold) },
                navigationIcon = {
                    IconButton(onClick = onBack) {
                        Icon(Icons.Default.ArrowBack, contentDescription = "Back", tint = textColor)
                    }
                },
                actions = {
                    // [FIX] Wrap in Box to anchor the Dropdown correctly
                    Box(modifier = Modifier.wrapContentSize(Alignment.TopEnd)) {

                        // [FIX] Use Surface(onClick = ...) instead of Row(Modifier.clickable)
                        // This ensures the button captures clicks properly in the TopBar.
                        Surface(
                            onClick = { rangeMenuExpanded = true },
                            shape = RoundedCornerShape(50),
                            color = MaterialTheme.colorScheme.surfaceVariant.copy(alpha = 0.5f),
                            modifier = Modifier.padding(end = 12.dp)
                        ) {
                            Row(
                                verticalAlignment = Alignment.CenterVertically,
                                modifier = Modifier.padding(horizontal = 12.dp, vertical = 6.dp)
                            ) {
                                Icon(
                                    imageVector = Icons.Default.CalendarToday,
                                    contentDescription = null,
                                    modifier = Modifier.size(14.dp),
                                    tint = textColor
                                )
                                Spacer(Modifier.width(6.dp))
                                Text(
                                    text = state.currentRange.label,
                                    style = MaterialTheme.typography.labelLarge,
                                    fontWeight = FontWeight.SemiBold,
                                    color = textColor
                                )
                                Spacer(Modifier.width(2.dp))
                                Icon(
                                    imageVector = Icons.Default.ArrowDropDown,
                                    contentDescription = null,
                                    tint = textColor
                                )
                            }
                        }

                        DropdownMenu(
                            expanded = rangeMenuExpanded,
                            onDismissRequest = { rangeMenuExpanded = false }
                        ) {
                            TimeRange.values().forEach { range ->
                                DropdownMenuItem(
                                    text = { Text(range.label) },
                                    onClick = {
                                        onTimeRangeSelected(range)
                                        rangeMenuExpanded = false
                                    }
                                )
                            }
                        }
                    }
                },
                colors = TopAppBarDefaults.topAppBarColors(containerColor = backgroundColor, titleContentColor = textColor)
            )
        }
    ) { padding ->
        LazyColumn(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
                .padding(horizontal = 16.dp),
            verticalArrangement = Arrangement.spacedBy(24.dp)
        ) {
            // 1. Quick Stats
            item {
                Column(verticalArrangement = Arrangement.spacedBy(12.dp)) {
                    Row(horizontalArrangement = Arrangement.spacedBy(12.dp)) {
                        StatBadge("Workouts", "${state.totalNotes}", Modifier.weight(1f))
                        StatBadge("Weekly Avg", String.format("%.1f", state.avgWorkoutsPerWeek), Modifier.weight(1f))
                    }
                    Row(horizontalArrangement = Arrangement.spacedBy(12.dp)) {
                        StatBadge("Avg Sets", String.format("%.1f", state.avgSets), Modifier.weight(1f))
                        StatBadge("Favorite", state.categoryCounts.maxByOrNull { it.value }?.key ?: "-", Modifier.weight(1f))
                    }
                }
            }

            // 2. Exercise Progress
            item {
                ExerciseProgressCard(repository = workoutRepository,timeRange = state.currentRange)
            }

            // 3. Duration Trend
            item {
                AdaptiveCard(height = 280.dp) {
                    Column(Modifier.padding(16.dp)) {
                        WorkoutDurationTrendChart(notes = state.filteredNotes, showRollingAvg = true)
                    }
                }
            }

            // 7. Heatmap
            item {
                AdaptiveCard(height = 300.dp) {
                    Column(Modifier.padding(16.dp)) {
                        TimeOfDayHeatmap(data = state.heatmapData)
                    }
                }
            }

            item { Spacer(Modifier.height(32.dp)) }
        }
    }
}

// --- HELPERS ---

@Composable
fun AdaptiveCard(modifier: Modifier = Modifier, height: androidx.compose.ui.unit.Dp? = null, content: @Composable () -> Unit) {
    var mod = modifier.fillMaxWidth()
    if (height != null) mod = mod.height(height)
    Card(
        colors = CardDefaults.cardColors(containerColor = CardDeepDark),
        shape = RoundedCornerShape(12.dp),
        modifier = mod
    ) { content() }
}

@Composable
fun StatBadge(label: String, value: String, modifier: Modifier = Modifier) {
    AdaptiveCard(modifier = modifier) {
        Column(
            modifier = Modifier.padding(16.dp).fillMaxWidth(),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Text(value, style = MaterialTheme.typography.headlineMedium, fontWeight = FontWeight.Bold, color = MaterialTheme.colorScheme.primary, maxLines = 1)
            Text(label, style = MaterialTheme.typography.labelSmall, color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.6f), maxLines = 1)
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\feature\stats\StatsViewModel.kt
=========================================

package com.example.gymtrack.feature.stats

import androidx.lifecycle.ViewModel
import androidx.lifecycle.ViewModelProvider
import androidx.lifecycle.viewModelScope
import com.example.gymtrack.core.data.NoteLine
import com.example.gymtrack.core.data.repository.NoteRepository
import com.example.gymtrack.core.util.parseDurationSeconds
import com.example.gymtrack.core.util.parseNoteText
import com.example.gymtrack.core.util.WorkoutParser
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.flow.*
import kotlinx.coroutines.withContext
import java.util.Calendar
import java.util.concurrent.TimeUnit

enum class TimeRange(val label: String, val days: Int) {
    LAST_WEEK("Last Week", 7),
    LAST_MONTH("Last Month", 30),
    LAST_3_MONTHS("Last 3 Months", 90), // [FIX] Added missing option
    LAST_6_MONTHS("Last 6 Months", 180),
    LAST_YEAR("Last Year", 365),
    ALL_TIME("All Time", -1)
}

data class StatsState(
    val totalNotes: Int = 0,
    val avgWorkoutsPerWeek: Float = 0f,
    val avgSets: Float = 0f,
    val categoryCounts: Map<String, Int> = emptyMap(),
    val averageDurations: Map<String, Float> = emptyMap(),
    val heatmapData: Array<IntArray> = Array(7) { IntArray(24) },
    val topExercises: List<Pair<String, Int>> = emptyList(),
    val currentRange: TimeRange = TimeRange.ALL_TIME,
    val filteredNotes: List<NoteLine> = emptyList()
)

class StatsViewModel(
    private val repository: NoteRepository
) : ViewModel() {

    private val _timeRange = MutableStateFlow(TimeRange.ALL_TIME)

    val uiState: StateFlow<StatsState> = combine(
        repository.getAllNotes(),
        _timeRange
    ) { notes, range ->
        calculateStats(notes, range)
    }.stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), StatsState())

    fun setTimeRange(range: TimeRange) {
        _timeRange.value = range
    }

    private suspend fun calculateStats(allNotes: List<NoteLine>, range: TimeRange): StatsState = withContext(Dispatchers.Default) {
        // [FIX] Strict math using TimeUnit.
        // "Last Month" = Exact last 30 days relative to NOW.
        val cutoff = if (range.days > 0) {
            System.currentTimeMillis() - TimeUnit.DAYS.toMillis(range.days.toLong())
        } else 0L

        val notes = allNotes.filter { it.timestamp >= cutoff }

        if (notes.isEmpty()) return@withContext StatsState(currentRange = range, filteredNotes = emptyList())

        val parser = WorkoutParser()

        // 1. Overview Stats
        val (mainCount, subCount) = notes.fold(0 to 0) { acc, note ->
            val lines = parseNoteText(note.text).first
            var main = 0
            var sub = 0
            for (l in lines) {
                if (l.isBlank()) continue
                if (l.startsWith("    ")) sub++ else main++
            }
            (acc.first + main) to (acc.second + sub)
        }
        val avgSets = if (mainCount > 0) subCount.toFloat() / mainCount else 0f

        // 2. Weekly Avg
        val minTime = notes.minOf { it.timestamp }
        val maxTime = notes.maxOf { it.timestamp }

        // Calculate exact weeks in the selected range (or actual data span if All Time)
        val durationWeeks = if (range == TimeRange.ALL_TIME) {
            val diff = (maxTime - minTime).coerceAtLeast(1L)
            diff.toFloat() / TimeUnit.DAYS.toMillis(7)
        } else {
            range.days / 7f
        }

        val avgWeekly = if (durationWeeks > 0) notes.size / durationWeeks else 0f

        // 3. Category Counts & Durations
        val counts = notes.groupingBy { it.categoryName ?: "Other" }.eachCount()

        val durationAvgs = notes.groupBy { it.categoryName ?: "Other" }
            .mapValues { entry ->
                val durations = entry.value.mapNotNull { note ->
                    parseNoteText(note.text).second.mapNotNull {
                        if (it.isBlank()) null else parseDurationSeconds(it)
                    }.maxOrNull()
                }
                if (durations.isEmpty()) 0f else durations.average().toFloat() / 60f
            }

        // 4. Heatmap
        val heatmap = Array(7) { IntArray(24) }
        notes.forEach { n ->
            val c = Calendar.getInstance().apply { timeInMillis = n.timestamp }
            val day = (c.get(Calendar.DAY_OF_WEEK) + 5) % 7
            val hour = c.get(Calendar.HOUR_OF_DAY)
            heatmap[day][hour]++
        }

        // 5. Top Exercises
        val exerciseCounts = notes.flatMap { note ->
            val sets = parser.parseWorkout(note.text)
            sets.map { it.exerciseName }
        }
            .groupingBy { it }
            .eachCount()
            .toList()
            .sortedByDescending { it.second }
            .take(5)

        StatsState(
            totalNotes = notes.size,
            avgWorkoutsPerWeek = avgWeekly,
            avgSets = avgSets,
            categoryCounts = counts,
            averageDurations = durationAvgs,
            heatmapData = heatmap,
            topExercises = exerciseCounts,
            currentRange = range,
            filteredNotes = notes
        )
    }

    class Factory(private val repository: NoteRepository) : ViewModelProvider.Factory {
        @Suppress("UNCHECKED_CAST")
        override fun <T : ViewModel> create(modelClass: Class<T>): T {
            return StatsViewModel(repository) as T
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\MainActivity.kt
=========================================

package com.example.gymtrack

import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.compose.runtime.remember
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.ui.platform.LocalContext
import androidx.navigation.compose.rememberNavController
import com.example.gymtrack.core.data.NoteDatabase
import com.example.gymtrack.core.data.Settings
import com.example.gymtrack.core.data.SettingsStore
import com.example.gymtrack.core.data.repository.NoteRepository
import com.example.gymtrack.core.data.WorkoutRepository
import com.example.gymtrack.core.ui.theme.GymTrackTheme
import com.example.gymtrack.feature.home.HomeViewModel
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext

class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        val db = NoteDatabase.getDatabase(applicationContext)
        val noteRepository = NoteRepository(db.noteDao())
        val workoutRepository = WorkoutRepository(db.noteDao(), db.exerciseDao(), db.setDao())

        setContent {
            val settingsState = remember { mutableStateOf(Settings()) }
            val context = LocalContext.current

            LaunchedEffect(Unit) {
                settingsState.value = SettingsStore.load(context)
                withContext(Dispatchers.IO) {
                    // [FIX] This re-reads ALL notes and rebuilds the charts.
                    // This will restore your missing 100+ sets immediately.
                    workoutRepository.forceUpdateStats()
                    workoutRepository.cleanUpOrphans()
                }
            }

            LaunchedEffect(settingsState.value) {
                SettingsStore.save(context, settingsState.value)
            }

            GymTrackTheme(darkTheme = settingsState.value.darkMode) {
                val navController = rememberNavController()

                NavigationHost(
                    navController = navController,
                    settings = settingsState.value,
                    onSettingsUpdate = { newSettings -> settingsState.value = newSettings },
                    noteRepository = noteRepository,
                    workoutRepository = workoutRepository
                )
            }
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\java\com\example\gymtrack\NavigationHost.kt
=========================================

package com.example.gymtrack

import androidx.compose.runtime.Composable
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.platform.LocalContext
import androidx.lifecycle.viewmodel.compose.viewModel
import androidx.navigation.NavHostController
import androidx.navigation.compose.NavHost
import androidx.navigation.compose.composable
import com.example.gymtrack.core.data.NoteLine
import com.example.gymtrack.core.data.Settings
import com.example.gymtrack.core.data.WorkoutRepository
import com.example.gymtrack.core.data.repository.NoteRepository
import com.example.gymtrack.feature.editor.EditorViewModel
import com.example.gymtrack.feature.editor.NoteEditor
import com.example.gymtrack.feature.home.HomeViewModel
import com.example.gymtrack.feature.home.NotesScreen
import com.example.gymtrack.feature.settings.SettingsScreen
import com.example.gymtrack.feature.stats.StatsScreen
import com.example.gymtrack.feature.stats.StatsViewModel

@Composable
fun NavigationHost(
    navController: NavHostController,
    settings: Settings,
    onSettingsUpdate: (Settings) -> Unit,
    noteRepository: NoteRepository,
    workoutRepository: WorkoutRepository
) {
    NavHost(navController = navController, startDestination = "notes") {

        // 1. HOME SCREEN
        composable("notes") {
            val context = LocalContext.current // [FIX] Get context for import
            val homeViewModel: HomeViewModel = viewModel(
                factory = HomeViewModel.Factory(noteRepository, workoutRepository)            )
            val notes by homeViewModel.notes.collectAsState()

            var selectedNotes by remember { mutableStateOf<Set<NoteLine>>(emptySet()) }

            NotesScreen(
                notes = notes,
                selectedNotes = selectedNotes,
                onSelect = { selectedNotes = it },
                onEdit = { note ->
                    navController.navigate("editor?noteId=${note.timestamp}")
                },
                onDelete = { selected ->
                    homeViewModel.deleteNotes(selected)
                    selectedNotes = emptySet() },
                onExport = { /* Export logic */ },
                onCreate = { navController.navigate("editor?noteId=-1") },
                // [FIX] Call the new import function
                onImport = { uri ->
                    homeViewModel.importNoteFromUri(context, uri, settings)
                },
                onOpenSettings = { navController.navigate("settings") },
                onOpenStats = { navController.navigate("stats") },
                onSwipeRight = { /* Swipe logic */ },
                settings = settings
            )
        }

        // ... (Rest of your composables remain the same)
        composable("editor?noteId={noteId}") { backStackEntry ->
            val noteId = backStackEntry.arguments?.getString("noteId")?.toLongOrNull() ?: -1L
            val context = LocalContext.current

            val editorViewModel: EditorViewModel = viewModel(
                factory = EditorViewModel.Factory(
                    noteId,
                    noteRepository,
                    workoutRepository,
                    context
                )
            )

            NoteEditor(
                viewModel = editorViewModel,
                settings = settings,
                isLastNote = true,
                onCancel = { navController.popBackStack() },
                onSaveSuccess = { navController.popBackStack() }
            )
        }

        composable("stats") {
            val statsViewModel: StatsViewModel = viewModel(
                factory = StatsViewModel.Factory(noteRepository)
            )
            val state by statsViewModel.uiState.collectAsState()

            StatsScreen(
                state = state,
                workoutRepository = workoutRepository,
                settings = settings,
                onTimeRangeSelected = { statsViewModel.setTimeRange(it) }, // [FIX]
                onBack = { navController.popBackStack() }
            )
        }

        composable("settings") {
            SettingsScreen(
                settings = settings,
                onUpdate = onSettingsUpdate,
                onBack = { navController.popBackStack() }
            )
        }
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\res\drawable\ic_launcher_background.xml
=========================================

<?xml version="1.0" encoding="utf-8"?>
<vector
    android:height="108dp"
    android:width="108dp"
    android:viewportHeight="108"
    android:viewportWidth="108"
    xmlns:android="http://schemas.android.com/apk/res/android">
    <path android:fillColor="#3DDC84"
          android:pathData="M0,0h108v108h-108z"/>
    <path android:fillColor="#00000000" android:pathData="M9,0L9,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,0L19,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M29,0L29,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M39,0L39,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M49,0L49,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M59,0L59,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M69,0L69,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M79,0L79,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M89,0L89,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M99,0L99,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,9L108,9"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,19L108,19"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,29L108,29"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,39L108,39"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,49L108,49"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,59L108,59"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,69L108,69"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,79L108,79"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,89L108,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,99L108,99"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,29L89,29"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,39L89,39"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,49L89,49"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,59L89,59"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,69L89,69"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,79L89,79"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M29,19L29,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M39,19L39,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M49,19L49,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M59,19L59,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M69,19L69,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M79,19L79,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
</vector>


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\res\drawable\ic_launcher_foreground.xml
=========================================

<vector xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:aapt="http://schemas.android.com/aapt"
    android:width="108dp"
    android:height="108dp"
    android:viewportWidth="108"
    android:viewportHeight="108">
    <path android:pathData="M31,63.928c0,0 6.4,-11 12.1,-13.1c7.2,-2.6 26,-1.4 26,-1.4l38.1,38.1L107,108.928l-32,-1L31,63.928z">
        <aapt:attr name="android:fillColor">
            <gradient
                android:endX="85.84757"
                android:endY="92.4963"
                android:startX="42.9492"
                android:startY="49.59793"
                android:type="linear">
                <item
                    android:color="#44000000"
                    android:offset="0.0" />
                <item
                    android:color="#00000000"
                    android:offset="1.0" />
            </gradient>
        </aapt:attr>
    </path>
    <path
        android:fillColor="#FFFFFF"
        android:fillType="nonZero"
        android:pathData="M65.3,45.828l3.8,-6.6c0.2,-0.4 0.1,-0.9 -0.3,-1.1c-0.4,-0.2 -0.9,-0.1 -1.1,0.3l-3.9,6.7c-6.3,-2.8 -13.4,-2.8 -19.7,0l-3.9,-6.7c-0.2,-0.4 -0.7,-0.5 -1.1,-0.3C38.8,38.328 38.7,38.828 38.9,39.228l3.8,6.6C36.2,49.428 31.7,56.028 31,63.928h46C76.3,56.028 71.8,49.428 65.3,45.828zM43.4,57.328c-0.8,0 -1.5,-0.5 -1.8,-1.2c-0.3,-0.7 -0.1,-1.5 0.4,-2.1c0.5,-0.5 1.4,-0.7 2.1,-0.4c0.7,0.3 1.2,1 1.2,1.8C45.3,56.528 44.5,57.328 43.4,57.328L43.4,57.328zM64.6,57.328c-0.8,0 -1.5,-0.5 -1.8,-1.2s-0.1,-1.5 0.4,-2.1c0.5,-0.5 1.4,-0.7 2.1,-0.4c0.7,0.3 1.2,1 1.2,1.8C66.5,56.528 65.6,57.328 64.6,57.328L64.6,57.328z"
        android:strokeWidth="1"
        android:strokeColor="#00000000" />
</vector>


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\res\mipmap-anydpi-v26\ic_launcher.xml
=========================================

<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@drawable/ic_launcher_background"/>
    <foreground android:drawable="@mipmap/ic_launcher_foreground"/>
</adaptive-icon>


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\res\mipmap-anydpi-v26\ic_launcher_round.xml
=========================================

<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@drawable/ic_launcher_background"/>
    <foreground android:drawable="@mipmap/ic_launcher_foreground"/>
</adaptive-icon>


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\res\values\colors.xml
=========================================

<?xml version="1.0" encoding="utf-8"?>
<resources>
    <color name="purple_200">#FFBB86FC</color>
    <color name="purple_500">#FF6200EE</color>
    <color name="purple_700">#FF3700B3</color>
    <color name="teal_200">#FF03DAC5</color>
    <color name="teal_700">#FF018786</color>
    <color name="black">#FF000000</color>
    <color name="white">#FFFFFFFF</color>
</resources>


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\res\values\strings.xml
=========================================

<resources>
    <string name="app_name">GymTrack</string>
</resources>


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\res\values\themes.xml
=========================================

<?xml version="1.0" encoding="utf-8"?>
<resources>

    <style name="Theme.GymTrack" parent="android:Theme.Material.Light.NoActionBar" />
</resources>


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\res\xml\backup_rules.xml
=========================================

<?xml version="1.0" encoding="utf-8"?><!--
   Sample backup rules file; uncomment and customize as necessary.
   See https://developer.android.com/guide/topics/data/autobackup
   for details.
   Note: This file is ignored for devices older than API 31
   See https://developer.android.com/about/versions/12/backup-restore
-->
<full-backup-content>
    <!--
   <include domain="sharedpref" path="."/>
   <exclude domain="sharedpref" path="device.xml"/>
-->
</full-backup-content>


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\res\xml\data_extraction_rules.xml
=========================================

<?xml version="1.0" encoding="utf-8"?><!--
   Sample data extraction rules file; uncomment and customize as necessary.
   See https://developer.android.com/about/versions/12/backup-restore#xml-changes
   for details.
-->
<data-extraction-rules>
    <cloud-backup>
        <!-- TODO: Use <include> and <exclude> to control what is backed up.
        <include .../>
        <exclude .../>
        -->
    </cloud-backup>
    <!--
    <device-transfer>
        <include .../>
        <exclude .../>
    </device-transfer>
    -->
</data-extraction-rules>


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\main\AndroidManifest.xml
=========================================

<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />

    <application
        android:allowBackup="true"
        android:dataExtractionRules="@xml/data_extraction_rules"
        android:fullBackupContent="@xml/backup_rules"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:enableOnBackInvokedCallback="true"
        android:theme="@style/Theme.GymTrack">
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:configChanges="orientation|screenSize|screenLayout|keyboardHidden"
            android:label="@string/app_name"
            android:theme="@style/Theme.GymTrack"
            android:windowSoftInputMode="adjustResize">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />

                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>

        <service
            android:name=".core.services.NoteTimerService"
            android:exported="false"
            android:foregroundServiceType="shortService" />
    </application>

</manifest>


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\test\java\com\example\gymtrack\ExampleUnitTest.kt
=========================================

package com.example.gymtrack

import org.junit.Test

import org.junit.Assert.*

/**
 * Example local unit test, which will execute on the development machine (host).
 *
 * See [testing documentation](http://d.android.com/tools/testing).
 */
class ExampleUnitTest {
    @Test
    fun addition_isCorrect() {
        assertEquals(4, 2 + 2)
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\test\java\com\example\gymtrack\FormatRelativeTimeTest.kt
=========================================

package com.example.gymtrack

import org.junit.Assert.assertEquals
import org.junit.Test
import java.text.SimpleDateFormat
import java.util.*
import com.example.gymtrack.core.data.Settings
import com.example.gymtrack.core.util.formatRelativeTime

class FormatRelativeTimeTest {
    @Test
    fun `recent time shows today prefix`() {
        val now = System.currentTimeMillis()
        val threeHoursAgo = now - 3 * 60 * 60 * 1000

        val expectedTime = SimpleDateFormat("HH:mm", Locale.getDefault()).format(Date(threeHoursAgo))
        assertEquals("Today $expectedTime", formatRelativeTime(threeHoursAgo, Settings()))

    }

    @Test
    fun `yesterday prefix used for timestamps between 24h and 48h`() {
        val now = System.currentTimeMillis()
        val thirtyHoursAgo = now - 30 * 60 * 60 * 1000
        val time = SimpleDateFormat("HH:mm", Locale.getDefault()).format(Date(thirtyHoursAgo))
        assertEquals("Yesterday $time", formatRelativeTime(thirtyHoursAgo, Settings()))
    }
}


=========================================
FILE PATH: C:\Users\znypr\AndroidStudioProjects\GymTrack\app\src\test\java\com\example\gymtrack\WorkoutParserTest.kt
=========================================

package com.example.gymtrack

import com.example.gymtrack.core.util.WorkoutParser
import org.junit.Assert.assertEquals
import org.junit.Test

class WorkoutParserTest {

    private val parser = WorkoutParser()

    @Test
    fun `parses standard entry 5x 100kg correctly`() {
        val rawText = """
            Bench Press
                5x 100kg
                5x 100kg
        """.trimIndent()

        val results = parser.parseWorkout(rawText)

        assertEquals(2, results.size)
        // First set
        assertEquals("Bench Press", results[0].exerciseName)
        assertEquals(100f, results[0].weight, 0.01f)
        assertEquals(5, results[0].reps)
    }

    @Test
    fun `handles shortcut entry (missing weight carries over)`() {
        // THIS is the scenario that was failing before because my test data was wrong.
        // It now uses your actual format:
        // Set 1: "5x 100kg" -> defines weight as 100
        // Set 2: "5x"       -> should inherit 100
        val rawText = """
            Bench Press
                5x 100kg
                5x
        """.trimIndent()

        val results = parser.parseWorkout(rawText)

        assertEquals(2, results.size)

        // Set 1: Explicit weight
        assertEquals(100f, results[0].weight, 0.01f)
        assertEquals(5, results[0].reps)

        // Set 2: Inherited weight
        assertEquals("Should carry over weight from previous set", 100f, results[1].weight, 0.01f)
        assertEquals(5, results[1].reps)
    }

    @Test
    fun `resets weight when exercise changes`() {
        val rawText = """
            Bench Press
                5x 100kg
            
            Squat
                5x
        """.trimIndent()

        val results = parser.parseWorkout(rawText)

        assertEquals(1, results.size)
        // Should ONLY parse Bench Press.
        // Squat has "5x" but no weight defined yet, so it should be skipped (or 0),
        // because we don't carry over weight across different exercises.
        assertEquals("Bench Press", results[0].exerciseName)
        assertEquals(100f, results[0].weight, 0.01f)
    }
}
